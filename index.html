<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplikasi Ujian Esai AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .prose-custom { max-width: none; }
        .prose-custom p { margin-top: 0.5em; margin-bottom: 0.5em; }
        .prose-custom h3 { margin-bottom: 0.5em; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
        .modal-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 50;
        }
    </style>
</head>
<body>

<div id="app" class="min-h-screen flex flex-col items-center p-4 sm:p-6">
    
    <!-- Header Aplikasi -->
    <header class="w-full max-w-4xl flex justify-between items-center mb-6 bg-white p-4 rounded-xl shadow-md">
        <h1 class="text-2xl font-bold text-gray-800">Ujian Esai AI</h1>
        <div class="flex items-center space-x-3">
            <span id="spreadsheetIdStatus" class="text-sm font-medium px-3 py-1 rounded-full bg-red-100 text-red-700 transition duration-300">
                ID Sheet: Belum diatur!
            </span>
            <button id="teacherSettingsBtn" class="p-2 text-gray-500 hover:text-blue-600 transition duration-150 rounded-full hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500" title="Pengaturan Guru">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M9.594 3.94c.09-.542.56-.94 1.11-.94h2.593c.55 0 1.02.398 1.11.94l.213 1.281c.062.37.316.666.62.813l.636.318c.54.27.76.91.51 1.446l-.382.787c-.23.473-.605.835-1.036 1.097l-.443.218c-.35.162-.56.51-.56.908v.75c0 .398.21.746.56.908l.443.218c.43.262.805.624 1.036 1.097l.382.787c.25.536.03 1.176-.51 1.446l-.636.318c-.304.147-.558.443-.62.813l-.213 1.281c-.09.542-.56.94-1.11.94h-2.593c-.55 0-1.02-.398-1.11-.94l-.213-1.281c-.062-.37-.316-.666-.62-.813l-.636-.318c-.54-.27-.76-.91-.51-1.446l.382-.787c.23-.473.605-.835 1.036-1.097l.443-.218c.35-.162.56-.51.56-.908v-.75c0-.398-.21-.746-.56-.908l-.443-.218c-.43-.262-.805-.624-1.036-1.097l-.382-.787c-.25-.536-.03-1.176.51-1.446l.636-.318c.304-.147.558-.443.62-.813l.213-1.281z" />
                    <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                </svg>
            </button>
        </div>
    </header>

    <!-- Modal Pengaturan Guru (hidden by default) -->
    <div id="settingsModal" class="modal-container hidden justify-center items-center">
        <div id="settingsBackdrop" class="absolute w-full h-full"></div>
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-3xl m-4 z-10 transform transition-all duration-300 scale-100">
            <div class="flex justify-between items-center p-5 border-b border-gray-200">
                <h2 class="text-xl font-semibold text-gray-800">Pengaturan Guru & Generator</h2>
                <button id="closeSettingsBtn" class="text-gray-400 hover:text-gray-600 transition duration-150">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>

            <!-- Konten Modal: 1. PIN Entry -->
            <div id="pinEntry" class="p-6">
                <h3 class="text-lg font-medium mb-4">Masukkan PIN Guru</h3>
                <input type="password" id="pinInput" placeholder="PIN" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 mb-3">
                <p id="pinMessage" class="text-sm h-5 mb-4"></p>
                <button id="submitPinBtn" class="w-full bg-blue-600 text-white p-3 rounded-lg font-semibold hover:bg-blue-700 transition duration-150 shadow-md">
                    Masuk
                </button>
                <p class="text-xs text-gray-500 mt-2 text-center">PIN default: 1234</p>
            </div>
            
            <!-- Konten Modal: 2. Main Settings & Tabs (Hidden by PIN) -->
            <div id="settingsContent" class="hidden p-6">
                
                <!-- Navigasi Tab -->
                <div class="flex border-b border-gray-200 mb-4">
                    <button id="tabConfigBtn" data-tab="config" class="tab-button px-4 py-2 text-sm font-medium text-blue-600 border-b-2 border-blue-600 transition duration-150 focus:outline-none">
                        Konfigurasi
                    </button>
                    <button id="tabGeneratorBtn" data-tab="generator" class="tab-button px-4 py-2 text-sm font-medium text-gray-500 hover:text-gray-700 transition duration-150 focus:outline-none">
                        Generator Soal
                    </button>
                    <button id="tabLinkGenBtn" data-tab="link-gen" class="tab-button px-4 py-2 text-sm font-medium text-gray-500 hover:text-gray-700 transition duration-150 focus:outline-none">
                        Link Ujian
                    </button>
                </div>
                
                <!-- Tab Content -->
                <div id="tabContent">
                    
                    <!-- Tab Konfigurasi (Config) -->
                    <div id="configTab" class="tab-page active">
                        <h3 class="text-lg font-semibold mb-3 text-gray-700">Pengaturan Aplikasi</h3>
                        
                        <div class="mb-4">
                            <label for="spreadsheetIdInput" class="block text-sm font-medium text-gray-700 mb-1">ID Google Spreadsheet (untuk Soal & Hasil)</label>
                            <input type="text" id="spreadsheetIdInput" placeholder="Masukkan ID Spreadsheet di sini" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                            <p class="text-xs text-gray-500 mt-1">ID ini digunakan untuk mengambil soal dan menyimpan hasil ujian.</p>
                        </div>

                        <div class="mb-4 p-4 border border-yellow-200 bg-yellow-50 rounded-lg">
                            <h4 class="text-sm font-medium text-yellow-800 mb-2">Ganti PIN Guru</h4>
                            <div class="flex space-x-2">
                                <div class="w-1/2">
                                    <label for="currentPinInput" class="block text-xs font-medium text-gray-600 mb-1">PIN Saat Ini</label>
                                    <input type="text" id="currentPinInput" class="w-full p-2 bg-gray-100 border border-gray-300 rounded-lg text-sm" disabled>
                                </div>
                                <div class="w-1/2">
                                    <label for="newPinInput" class="block text-xs font-medium text-gray-600 mb-1">PIN Baru (Kosongkan jika tidak diganti)</label>
                                    <input type="password" id="newPinInput" placeholder="PIN Baru" class="w-full p-2 border border-gray-300 rounded-lg text-sm focus:ring-blue-500 focus:border-blue-500">
                                </div>
                            </div>
                        </div>

                        <p id="settingsMessage" class="text-sm h-5 mb-4"></p>
                        <button id="saveSettingsBtn" class="w-full bg-green-600 text-white p-3 rounded-lg font-semibold hover:bg-green-700 transition duration-150 shadow-md">
                            Simpan Pengaturan
                        </button>
                    </div>

                    <!-- Tab Generator Soal -->
                    <div id="generatorTab" class="tab-page hidden">
                        <h3 class="text-lg font-semibold mb-3 text-gray-700">Buat Soal Baru dengan AI</h3>
                        <textarea id="generatorPrompt" rows="4" placeholder="Contoh: Buatkan 8 soal esai tentang dampak perubahan iklim terhadap ekosistem laut." class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 mb-4"></textarea>
                        <p id="generatorMessage" class="text-sm h-5 mb-4"></p>
                        <button id="generateQuestionsBtn" class="w-full bg-purple-600 text-white p-3 rounded-lg font-semibold hover:bg-purple-700 transition duration-150 shadow-md flex items-center justify-center">
                            <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white hidden" id="generatorSpinner" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                            Generate Soal & Simpan ke Sheet
                        </button>
                    </div>

                    <!-- Tab Link Generator -->
                    <div id="link-genTab" class="tab-page hidden">
                        <h3 class="text-lg font-semibold mb-3 text-gray-700">Link Berbagi Ujian</h3>
                        <div class="mb-4">
                            <label for="linkName" class="block text-sm font-medium text-gray-700 mb-1">Nama Ujian (misal: Ujian Harian Bab 1)</label>
                            <input type="text" id="linkName" placeholder="Nama Ujian" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div class="flex items-center space-x-2 mb-4">
                            <input type="text" id="generatedLink" class="flex-grow p-3 bg-gray-100 border border-gray-300 rounded-lg text-sm" readonly placeholder="Link akan muncul di sini...">
                            <button id="copyLinkBtn" class="bg-gray-200 text-gray-700 p-3 rounded-lg font-semibold hover:bg-gray-300 transition duration-150">
                                Salin
                            </button>
                        </div>
                        <p id="linkGenMessage" class="text-sm h-5 mb-4"></p>
                        <button id="createLinkBtn" class="w-full bg-indigo-600 text-white p-3 rounded-lg font-semibold hover:bg-indigo-700 transition duration-150 shadow-md">
                            Buat Link Ujian
                        </button>
                        <p class="text-xs text-gray-500 mt-2">Pastikan Spreadsheet ID sudah diatur sebelum membuat link.</p>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <!-- Main Content Area -->
    <div id="main-ui" class="w-full max-w-4xl p-6 bg-white rounded-xl shadow-md">
        <div id="start-screen">
            <h2 class="text-xl font-semibold mb-4 text-gray-800">Mulai Ujian</h2>
            <div class="space-y-4 mb-6">
                <div>
                    <label for="studentNameInput" class="block text-sm font-medium text-gray-700 mb-1">Nama Siswa</label>
                    <input type="text" id="studentNameInput" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" placeholder="Masukkan nama Anda">
                </div>
                <div class="flex space-x-4">
                    <div class="w-1/2">
                        <label for="studentClassInput" class="block text-sm font-medium text-gray-700 mb-1">Kelas</label>
                        <input type="text" id="studentClassInput" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" placeholder="Contoh: X-A">
                    </div>
                    <div class="w-1/2">
                        <label for="subjectInput" class="block text-sm font-medium text-gray-700 mb-1">Mata Pelajaran</label>
                        <input type="text" id="subjectInput" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" placeholder="Contoh: Sejarah">
                    </div>
                </div>
            </div>
            <button id="startQuizBtn" class="w-full bg-blue-600 text-white p-3 rounded-lg font-semibold hover:bg-blue-700 transition duration-150 shadow-md">
                Mulai Ujian
            </button>
            <p id="startMessage" class="mt-4 text-sm text-red-500 text-center"></p>
        </div>

        <div id="quiz-screen" class="hidden">
            <div class="flex justify-between items-center mb-4 pb-2 border-b border-gray-200">
                <h3 class="text-xl font-semibold text-gray-800">Soal <span id="currentQuestionIndex">1</span> dari <span id="totalQuestionsCount">1</span></h3>
                <span id="quizStatus" class="px-3 py-1 text-sm font-medium rounded-full bg-blue-100 text-blue-700">Berjalan</span>
            </div>
            
            <div id="questionContainer" class="mb-6 p-4 bg-gray-50 rounded-lg border border-gray-200">
                <p id="questionText" class="text-lg text-gray-800"></p>
            </div>
            
            <div class="mb-4">
                <label class="block text-md font-medium text-gray-700 mb-2">Jawaban Anda:</label>
                <div id="writingToolbar" class="flex flex-wrap gap-1 mb-2">
                    <!-- Toolbar karakter khusus (misal: untuk Matematika/Sains) -->
                    <button data-char="α" class="toolbar-btn bg-gray-200 hover:bg-gray-300 p-2 rounded-md text-sm">α</button>
                    <button data-char="β" class="toolbar-btn bg-gray-200 hover:bg-gray-300 p-2 rounded-md text-sm">β</button>
                    <button data-char="Σ" class="toolbar-btn bg-gray-200 hover:bg-gray-300 p-2 rounded-md text-sm">Σ</button>
                    <button data-char="°" class="toolbar-btn bg-gray-200 hover:bg-gray-300 p-2 rounded-md text-sm">°</button>
                    <button data-char="±" class="toolbar-btn bg-gray-200 hover:bg-gray-300 p-2 rounded-md text-sm">±</button>
                </div>
                <textarea id="studentAnswerInput" rows="8" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 resize-none" placeholder="Tulis jawaban esai Anda di sini..."></textarea>
            </div>

            <div class="flex justify-between space-x-4">
                <button id="prevQuestionBtn" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-lg font-semibold hover:bg-gray-400 transition duration-150 w-1/3 disabled:opacity-50" disabled>
                    &larr; Sebelumnya
                </button>
                <button id="nextQuestionBtn" class="px-4 py-2 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700 transition duration-150 w-1/3">
                    Lanjut &rarr;
                </button>
                <button id="submitAnswerBtn" class="px-4 py-2 bg-green-600 text-white rounded-lg font-semibold hover:bg-green-700 transition duration-150 w-1/3 hidden">
                    Koreksi Jawaban
                </button>
            </div>
            <p id="quizMessage" class="mt-4 text-sm h-5 text-center"></p>
        </div>

        <div id="results-screen" class="hidden">
            <h2 class="text-2xl font-bold mb-4 text-gray-800">Hasil Ujian</h2>
            
            <div class="bg-blue-50 p-6 rounded-xl shadow-inner mb-6">
                <div class="flex justify-between items-center mb-3">
                    <span class="text-lg font-medium text-gray-700">Skor Rata-rata:</span>
                    <span id="averageScoreDisplay" class="text-3xl font-extrabold text-blue-600">0</span>
                </div>
                <div class="flex justify-between text-sm text-gray-600">
                    <span>Total Soal:</span>
                    <span id="totalQuestionsDisplay">0</span>
                </div>
                <div class="flex justify-between text-sm text-gray-600">
                    <span>Waktu:</span>
                    <span id="studentInfoDisplay"></span>
                </div>
            </div>

            <h3 class="text-xl font-semibold mb-3 text-gray-800">Detail Koreksi</h3>
            <div id="detailedResults" class="space-y-6">
                <!-- Detailed results will be inserted here -->
            </div>

            <div class="mt-8 flex space-x-4">
                <button id="retakeQuizBtn" class="flex-1 bg-yellow-600 text-white p-3 rounded-lg font-semibold hover:bg-yellow-700 transition duration-150 shadow-md">
                    Ulangi Ujian
                </button>
                <button id="downloadPdfBtn" class="flex-1 bg-red-600 text-white p-3 rounded-lg font-semibold hover:bg-red-700 transition duration-150 shadow-md">
                    Unduh PDF
                </button>
            </div>
            <p id="resultsMessage" class="mt-4 text-sm h-5 text-center"></p>
        </div>
        
    </div>
</div>

<script>
    // --- Variabel Global ---
    let quizData = [];
    let currentQuestionIndex = 0;
    let studentInfo = { name: '', class: '', subject: '' };
    const APP_SCRIPT_URL = 'YOUR_APPS_SCRIPT_URL_HERE'; // GANTI DENGAN URL DEPLOY ANDA

    // --- DOM Elements ---
    const startScreen = document.getElementById('start-screen');
    const quizScreen = document.getElementById('quiz-screen');
    const resultsScreen = document.getElementById('results-screen');
    const questionText = document.getElementById('questionText');
    const studentAnswerInput = document.getElementById('studentAnswerInput');
    const teacherSettingsBtn = document.getElementById('teacherSettingsBtn');
    const settingsModal = document.getElementById('settingsModal');
    const settingsBackdrop = document.getElementById('settingsBackdrop');
    const closeSettingsBtn = document.getElementById('closeSettingsBtn');
    const pinInput = document.getElementById('pinInput');
    const submitPinBtn = document.getElementById('submitPinBtn');
    const settingsContent = document.getElementById('settingsContent');
    const pinEntry = document.getElementById('pinEntry');
    const saveSettingsBtn = document.getElementById('saveSettingsBtn');
    const spreadsheetIdInput = document.getElementById('spreadsheetIdInput');
    const currentPinInput = document.getElementById('currentPinInput');
    const newPinInput = document.getElementById('newPinInput');
    const generatorPrompt = document.getElementById('generatorPrompt');
    const generateQuestionsBtn = document.getElementById('generateQuestionsBtn');
    const generatorSpinner = document.getElementById('generatorSpinner');
    const writingToolbar = document.getElementById('writingToolbar');

    // Tab buttons
    const tabConfigBtn = document.getElementById('tabConfigBtn');
    const tabGeneratorBtn = document.getElementById('tabGeneratorBtn');
    const tabLinkGenBtn = document.getElementById('tabLinkGenBtn');


    // --- UTILITY FUNCTIONS ---

    function showMessage(message, elementId, className = 'text-red-500') {
        const el = document.getElementById(elementId);
        if (el) {
            el.textContent = message;
            el.className = `mt-2 text-sm text-center ${className}`;
        }
    }

    function insertAtCursor(textarea, text) {
        const start = textarea.selectionStart;
        const end = textarea.selectionEnd;
        const value = textarea.value;
        
        textarea.value = value.substring(0, start) + text + value.substring(end);
        textarea.selectionStart = textarea.selectionEnd = start + text.length;
        textarea.focus();
    }

    // --- CORE LOGIC: API INTERACTION ---

    async function sendRequest(action, data = {}) {
        const spreadsheetId = localStorage.getItem('spreadsheetId');
        if (!spreadsheetId && action !== 'testConnection') {
            showMessage("Error: Spreadsheet ID belum diatur. Masuk ke Pengaturan Guru.", 'quizMessage');
            return { success: false, message: "Spreadsheet ID is not set." };
        }

        const payload = {
            action: action,
            spreadsheetId: spreadsheetId,
            ...data
        };
        
        // Sederhanakan URL untuk memudahkan pengujian di lingkungan sandbox
        let url = APP_SCRIPT_URL;

        if (url === 'YOUR_APPS_SCRIPT_URL_HERE') {
            showMessage("Error: Harap ganti 'YOUR_APPS_SCRIPT_URL_HERE' dengan URL Apps Script Anda.", 'quizMessage', 'text-red-600');
            return { success: false, message: "URL Apps Script must be set." };
        }

        try {
            const response = await fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                // Tangani respons HTTP non-200
                const errorText = await response.text();
                throw new Error(`HTTP Error: ${response.status} - ${errorText}`);
            }

            return await response.json();

        } catch (error) {
            console.error('Fetch Error:', error);
            showMessage(`Koneksi Gagal/Error Server: ${error.message.substring(0, 100)}...`, 'quizMessage');
            return { success: false, message: "Koneksi ke Apps Script gagal." };
        }
    }

    // --- QUIZ FLOW FUNCTIONS ---

    async function startQuiz() {
        studentInfo.name = document.getElementById('studentNameInput').value.trim();
        studentInfo.class = document.getElementById('studentClassInput').value.trim();
        studentInfo.subject = document.getElementById('subjectInput').value.trim();
        
        if (!studentInfo.name || !studentInfo.class || !studentInfo.subject) {
            showMessage("Harap isi Nama, Kelas, dan Mata Pelajaran.", 'startMessage');
            return;
        }

        // Dummy data for simulation (Replace this with real data fetching if needed later)
        quizData = [
            { question: "Jelaskan proses fotosintesis secara rinci dan faktor-faktor yang mempengaruhinya.", keyAnswer: "Fotosintesis adalah proses di mana tumbuhan mengubah energi cahaya menjadi glukosa. Kunci jawabannya harus mencakup langkah-langkah (reaksi terang dan gelap) serta faktor-faktor (cahaya, air, CO2, suhu).", studentAnswer: "", score: null, feedback: null },
            { question: "Tuliskan biografi singkat tentang salah satu tokoh proklamator Indonesia.", keyAnswer: "Jelaskan Soekarno atau Hatta, mencakup tanggal lahir, peran dalam proklamasi, dan kontribusi utama setelah kemerdekaan.", studentAnswer: "", score: null, feedback: null },
            { question: "Mengapa revolusi industri membawa dampak buruk bagi lingkungan hidup?", keyAnswer: "Fokus pada peningkatan polusi dari pabrik, penggunaan bahan bakar fosil, dan urbanisasi yang merusak habitat.", studentAnswer: "", score: null, feedback: null }
        ];

        if (quizData.length === 0) {
            showMessage("Tidak ada soal yang tersedia. Harap hubungi guru Anda.", 'startMessage', 'text-orange-500');
            return;
        }

        document.getElementById('totalQuestionsCount').textContent = quizData.length;
        currentQuestionIndex = 0;
        
        startScreen.classList.add('hidden');
        quizScreen.classList.remove('hidden');
        resultsScreen.classList.add('hidden');
        
        displayQuestion();
        showMessage('', 'startMessage');
    }

    function displayQuestion() {
        const data = quizData[currentQuestionIndex];
        
        questionText.textContent = data.question;
        studentAnswerInput.value = data.studentAnswer || '';
        document.getElementById('currentQuestionIndex').textContent = currentQuestionIndex + 1;
        
        // Update button visibility
        document.getElementById('prevQuestionBtn').disabled = (currentQuestionIndex === 0);
        
        if (currentQuestionIndex === quizData.length - 1) {
            document.getElementById('nextQuestionBtn').classList.add('hidden');
            document.getElementById('submitAnswerBtn').classList.remove('hidden');
        } else {
            document.getElementById('nextQuestionBtn').classList.remove('hidden');
            document.getElementById('submitAnswerBtn').classList.add('hidden');
        }
    }

    function navigate(direction) {
        // Save current answer before navigating
        quizData[currentQuestionIndex].studentAnswer = studentAnswerInput.value;

        if (direction === 'prev' && currentQuestionIndex > 0) {
            currentQuestionIndex--;
        } else if (direction === 'next' && currentQuestionIndex < quizData.length - 1) {
            currentQuestionIndex++;
        }
        displayQuestion();
    }

    async function submitAnswer() {
        // Save the final answer
        quizData[currentQuestionIndex].studentAnswer = studentAnswerInput.value;

        if (!confirm("Anda yakin ingin mengirim semua jawaban untuk dikoreksi?")) {
            return;
        }

        showMessage("Mengirim jawaban untuk dikoreksi AI... Harap tunggu.", 'quizMessage', 'text-blue-600');
        
        // Loop through all questions and send them to gradeAnswer API
        let allGradedResults = [];
        let scoreSum = 0;

        for (const [index, item] of quizData.entries()) {
            if (!item.studentAnswer) {
                // Skip if no answer is provided, treat as 0 score
                item.score = 0;
                item.feedback = "Tidak ada jawaban yang diberikan.";
            } else {
                const result = await sendRequest('gradeAnswer', {
                    question: item.question,
                    keyAnswer: item.keyAnswer,
                    studentAnswer: item.studentAnswer
                });

                if (result.success) {
                    item.score = result.score;
                    item.feedback = result.feedback;
                } else {
                    item.score = 0;
                    item.feedback = `Koreksi AI Gagal: ${result.message}`;
                }
            }
            scoreSum += item.score;
            
            // Update UI during grading (optional, for feedback)
            showMessage(`Mengoreksi soal ${index + 1} dari ${quizData.length}...`, 'quizMessage', 'text-blue-600');
        }
        
        const averageScore = Math.round(scoreSum / quizData.length);

        // Prepare final result data for saving
        const finalResult = {
            studentName: studentInfo.name,
            studentClass: studentInfo.class,
            subject: studentInfo.subject,
            averageScore: averageScore,
            totalQuestions: quizData.length,
            detail: quizData.map(q => ({
                question: q.question,
                answer: q.studentAnswer,
                score: q.score,
                feedback: q.feedback
            }))
        };

        // Save results to Google Sheet
        const saveResponse = await sendRequest('saveResult', { result: finalResult });

        if (saveResponse.success) {
            showMessage("Koreksi selesai. Hasil berhasil dicatat.", 'quizMessage', 'text-green-600');
        } else {
            showMessage(`Koreksi selesai. Gagal mencatat hasil: ${saveResponse.message}`, 'quizMessage', 'text-orange-600');
        }

        displayResults(finalResult);
    }

    function displayResults(finalResult) {
        quizScreen.classList.add('hidden');
        resultsScreen.classList.remove('hidden');
        
        document.getElementById('averageScoreDisplay').textContent = finalResult.averageScore;
        document.getElementById('totalQuestionsDisplay').textContent = finalResult.totalQuestions;
        document.getElementById('studentInfoDisplay').textContent = `${finalResult.studentName} (${finalResult.studentClass}, ${finalResult.subject})`;

        const detailedResults = document.getElementById('detailedResults');
        detailedResults.innerHTML = '';
        
        finalResult.detail.forEach((item, index) => {
            const html = `
                <div class="p-4 border border-gray-200 rounded-lg shadow-sm">
                    <div class="flex justify-between items-start mb-2">
                        <h4 class="font-bold text-gray-800">Soal ${index + 1}</h4>
                        <span class="text-2xl font-extrabold text-green-600">${item.score}/100</span>
                    </div>
                    <p class="text-gray-700 mb-2">${item.question}</p>
                    <div class="mt-3 p-3 bg-gray-50 border-l-4 border-blue-400 rounded-md">
                        <p class="font-medium text-blue-800 mb-1">Jawaban Siswa:</p>
                        <p class="text-sm text-gray-700 whitespace-pre-wrap">${item.answer || 'Tidak ada jawaban'}</p>
                    </div>
                    <div class="mt-3 p-3 bg-green-50 border-l-4 border-green-400 rounded-md">
                        <p class="font-medium text-green-800 mb-1">Umpan Balik AI:</p>
                        <p class="text-sm text-gray-700 whitespace-pre-wrap">${item.feedback}</p>
                    </div>
                </div>
            `;
            detailedResults.insertAdjacentHTML('beforeend', html);
        });
    }

    function retakeQuiz() {
        // Clear answers and reset state
        quizData.forEach(q => {
            q.studentAnswer = "";
            q.score = null;
            q.feedback = null;
        });
        currentQuestionIndex = 0;
        
        resultsScreen.classList.add('hidden');
        startScreen.classList.remove('hidden');
        showMessage('', 'resultsMessage');
    }

    async function downloadResultsAsPDF() {
        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF('p', 'mm', 'a4');
        const element = document.getElementById('results-screen');
        
        showMessage('Membuat PDF... Harap tunggu.', 'resultsMessage', 'text-blue-600');

        // Menggunakan html2canvas untuk menangkap tampilan hasil
        html2canvas(element, { scale: 2 }).then(canvas => {
            const imgData = canvas.toDataURL('image/png');
            const imgWidth = 210; 
            const pageHeight = 295; 
            const imgHeight = canvas.height * imgWidth / canvas.width;
            let heightLeft = imgHeight;
            
            let position = 0;

            pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
            heightLeft -= pageHeight;

            while (heightLeft >= 0) {
                position = heightLeft - imgHeight;
                pdf.addPage();
                pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                heightLeft -= pageHeight;
            }

            pdf.save(`Hasil_Ujian_${studentInfo.name.replace(/\s/g, '_')}.pdf`);
            showMessage('PDF berhasil dibuat.', 'resultsMessage', 'text-green-600');
        }).catch(error => {
            console.error("Error generating PDF:", error);
            showMessage('Gagal membuat PDF. Coba lagi.', 'resultsMessage', 'text-red-600');
        });
    }

    // --- SETTINGS/TEACHER FUNCTIONS ---

    // ** FUNGSI YANG DIPERBAIKI UNTUK MEMBUKA MODAL **
    function openSettingsModal() {
        settingsModal.classList.remove('hidden');
        settingsModal.classList.add('flex');
        
        // Load settings when opening
        loadSettings();

        // Show PIN input first
        pinEntry.classList.remove('hidden');
        settingsContent.classList.add('hidden');
        pinInput.value = ''; // Clear PIN input
        showMessage('', 'pinMessage'); // Clear pin message
        
        // Set default tab to config
        switchTab('config');
    }

    function closeSettingsModal() {
        settingsModal.classList.add('hidden');
        settingsModal.classList.remove('flex');
    }

    function checkPin() {
        const enteredPin = pinInput.value;
        const currentPin = localStorage.getItem('teacherPin') || '1234'; // Default PIN

        if (enteredPin === currentPin) {
            pinEntry.classList.add('hidden');
            settingsContent.classList.remove('hidden');
            showMessage('PIN Benar. Akses Pengaturan Guru.', 'pinMessage', 'text-green-500');
            
            // Load settings content after successful login
            spreadsheetIdInput.value = localStorage.getItem('spreadsheetId') || '';
            currentPinInput.value = currentPin;
        } else {
            showMessage('PIN salah. Coba lagi.', 'pinMessage', 'text-red-500');
        }
    }

    function saveSettings() {
        const newSpreadsheetId = spreadsheetIdInput.value.trim();
        const newPin = newPinInput.value.trim();

        if (newSpreadsheetId) {
            localStorage.setItem('spreadsheetId', newSpreadsheetId);
        }
        
        if (newPin) {
            localStorage.setItem('teacherPin', newPin);
            currentPinInput.value = newPin; // Update current PIN display
            newPinInput.value = ''; // Clear new PIN input
            showMessage('Pengaturan dan PIN Baru berhasil disimpan!', 'settingsMessage', 'text-green-500');
        } else {
            showMessage('Pengaturan berhasil disimpan.', 'settingsMessage', 'text-green-500');
        }
        
        // Update the UI status on the main page
        loadSettings();
    }
    
    function loadSettings() {
        const spreadsheetId = localStorage.getItem('spreadsheetId');
        const teacherPin = localStorage.getItem('teacherPin') || '1234'; 
        
        const statusEl = document.getElementById('spreadsheetIdStatus');
        if (statusEl) {
            if (spreadsheetId) {
                statusEl.textContent = `ID Sheet: ${spreadsheetId.substring(0, 8)}... (OK)`;
                statusEl.classList.remove('bg-red-100', 'text-red-700');
                statusEl.classList.add('bg-green-100', 'text-green-700');
            } else {
                statusEl.textContent = "ID Sheet: Belum diatur!";
                statusEl.classList.remove('bg-green-100', 'text-green-700');
                statusEl.classList.add('bg-red-100', 'text-red-700');
            }
        }
        
        // Also update modal fields if they are visible
        if (!settingsContent.classList.contains('hidden')) {
             spreadsheetIdInput.value = spreadsheetId || '';
             currentPinInput.value = teacherPin;
        }
    }

    function switchTab(tabId) {
        // Hide all tab pages
        document.querySelectorAll('.tab-page').forEach(page => page.classList.add('hidden'));
        // Deactivate all tab buttons
        document.querySelectorAll('.tab-button').forEach(button => {
            button.classList.remove('border-blue-600', 'text-blue-600');
            button.classList.add('border-transparent', 'text-gray-500');
        });

        // Show the selected tab page
        document.getElementById(tabId + 'Tab').classList.remove('hidden');
        
        // Activate the selected tab button
        document.getElementById('tab' + tabId.charAt(0).toUpperCase() + tabId.slice(1) + 'Btn').classList.remove('border-transparent', 'text-gray-500');
        document.getElementById('tab' + tabId.charAt(0).toUpperCase() + tabId.slice(1) + 'Btn').classList.add('border-blue-600', 'text-blue-600');
        
        showMessage('', 'generatorMessage');
    }
    
    async function generateQuestions() {
        const prompt = generatorPrompt.value.trim();
        if (!prompt) {
            showMessage("Masukkan prompt soal yang ingin digenerate.", 'generatorMessage', 'text-red-500');
            return;
        }

        generatorSpinner.classList.remove('hidden');
        generateQuestionsBtn.disabled = true;
        showMessage('Menggenerate soal dengan AI... ini mungkin memakan waktu.', 'generatorMessage', 'text-blue-600');

        const result = await sendRequest('generateQuestions', { prompt: prompt });

        generatorSpinner.classList.add('hidden');
        generateQuestionsBtn.disabled = false;
        
        if (result.success) {
            showMessage(result.message, 'generatorMessage', 'text-green-600');
            generatorPrompt.value = '';
        } else {
            showMessage(result.message, 'generatorMessage', 'text-red-600');
        }
    }
    
    function createLink() {
        const linkName = document.getElementById('linkName').value.trim();
        const spreadsheetId = localStorage.getItem('spreadsheetId');
        const generatedLink = document.getElementById('generatedLink');
        
        if (!spreadsheetId) {
            showMessage('Harap atur Spreadsheet ID di tab Konfigurasi terlebih dahulu.', 'linkGenMessage', 'text-red-500');
            return;
        }
        
        // URL Apps Script Web App Anda (pastikan sudah di-deploy)
        const baseUrl = APP_SCRIPT_URL.replace('/exec', '/dev'); // Gunakan /dev untuk link yang bisa diubah jika belum production
        
        // Buat URL dengan parameter
        const urlParams = new URLSearchParams();
        urlParams.append('id', spreadsheetId);
        if (linkName) {
            urlParams.append('ujian', encodeURIComponent(linkName));
        }

        const fullLink = `${baseUrl}?${urlParams.toString()}`;
        generatedLink.value = fullLink;
        showMessage('Link berhasil dibuat.', 'linkGenMessage', 'text-green-500');
    }

    function copyLink() {
        const generatedLink = document.getElementById('generatedLink');
        if (generatedLink.value) {
            navigator.clipboard.writeText(generatedLink.value).then(() => {
                showMessage('Link berhasil disalin!', 'linkGenMessage', 'text-green-500');
            }).catch(err => {
                showMessage('Gagal menyalin link.', 'linkGenMessage', 'text-red-500');
            });
        }
    }

    // --- INITIALIZATION ---
    window.addEventListener('DOMContentLoaded', () => {
        // Quiz buttons
        document.getElementById('startQuizBtn').addEventListener('click', startQuiz);
        document.getElementById('prevQuestionBtn').addEventListener('click', () => navigate('prev'));
        document.getElementById('nextQuestionBtn').addEventListener('click', () => navigate('next'));
        document.getElementById('submitAnswerBtn').addEventListener('click', submitAnswer);
        document.getElementById('retakeQuizBtn').addEventListener('click', retakeQuiz);
        document.getElementById('downloadPdfBtn').addEventListener('click', downloadResultsAsPDF);
        
        // Pengaturan Guru (FIXED)
        teacherSettingsBtn.addEventListener('click', openSettingsModal);
        settingsBackdrop.addEventListener('click', closeSettingsModal);
        closeSettingsBtn.addEventListener('click', closeSettingsModal);
        submitPinBtn.addEventListener('click', checkPin);
        saveSettingsBtn.addEventListener('click', saveSettings);

        // Navigasi Tab
        document.querySelectorAll('.tab-button').forEach(btn => {
            btn.addEventListener('click', (e) => switchTab(e.target.dataset.tab));
        });
        
        // Generator Soal
        generateQuestionsBtn.addEventListener('click', generateQuestions);
        
        // Generator Link
        document.getElementById('createLinkBtn').addEventListener('click', createLink);
        document.getElementById('copyLinkBtn').addEventListener('click', copyLink);

        // Toolbar
        writingToolbar.addEventListener('click', (e) => {
            if (e.target.tagName === 'BUTTON' && e.target.dataset.char) {
                insertAtCursor(studentAnswerInput, e.target.dataset.char);
            }
        });

        // Muat pengaturan saat aplikasi dimulai
        loadSettings();
    });
</script>
</body>
</html>
