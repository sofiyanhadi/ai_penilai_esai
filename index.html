<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplikasi Ujian Esai AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Menggunakan jsPDF untuk membuat PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- Menggunakan html2canvas untuk mengonversi HTML ke gambar (untuk PDF) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .prose-custom { max-width: none; }
        .prose-custom p { margin-top: 0.5em; margin-bottom: 0.5em; }
        .prose-custom h3 { margin-bottom: 0.5em; }
        /* Scrollbar kustom */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        /* Style untuk penanda loading */
        .loading-dots:after {
            content: ' .';
            animation: dots 1s steps(5, end) infinite;
        }
        @keyframes dots {
            0%, 20% { color: rgba(0,0,0,0); text-shadow: .25em 0 0 rgba(0,0,0,0), .5em 0 0 rgba(0,0,0,0); }
            40% { color: black; text-shadow: .25em 0 0 rgba(0,0,0,0), .5em 0 0 rgba(0,0,0,0); }
            60% { text-shadow: .25em 0 0 black, .5em 0 0 rgba(0,0,0,0); }
            80%, 100% { text-shadow: .25em 0 0 black, .5em 0 0 black; }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col p-4">

    <!-- Kontainer Utama Aplikasi -->
    <main class="max-w-4xl w-full mx-auto bg-white shadow-xl rounded-xl p-6 md:p-10 flex-grow">
        
        <!-- Header -->
        <header class="mb-6 border-b pb-4 flex justify-between items-center">
            <h1 class="text-3xl font-bold text-gray-800">Ujian Esai Otomatis</h1>
            <button id="teacher-settings-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-300 transform hover:scale-105">
                Pengaturan Guru
            </button>
        </header>

        <!-- Area Soal -->
        <section id="question-area" class="mb-8 p-4 bg-indigo-50 border border-indigo-200 rounded-lg shadow-inner">
            <h2 class="text-xl font-semibold mb-2 text-indigo-800">Soal Ujian</h2>
            <div id="quiz-question" class="prose-custom max-w-none text-gray-700 min-h-[50px]">
                <!-- Soal akan dimuat di sini -->
                <p>Silakan tunggu soal dimuat, atau tekan tombol **Pengaturan Guru** untuk membuat soal baru.</p>
            </div>
        </section>

        <!-- Area Jawaban Siswa -->
        <section class="mb-8">
            <h2 class="text-xl font-semibold mb-3 text-gray-800">Jawaban Anda</h2>
            
            <!-- Toolbar Karakter Khusus -->
            <div id="writing-toolbar" class="flex flex-wrap gap-2 mb-3 p-3 bg-gray-100 rounded-lg border">
                <span class="text-sm font-medium text-gray-600 mr-2">Karakter Khusus:</span>
                <button class="px-2 py-1 text-sm bg-white border rounded-md hover:bg-gray-200" data-char="α">α</button>
                <button class="px-2 py-1 text-sm bg-white border rounded-md hover:bg-gray-200" data-char="β">β</button>
                <button class="px-2 py-1 text-sm bg-white border rounded-md hover:bg-gray-200" data-char="γ">γ</button>
                <button class="px-2 py-1 text-sm bg-white border rounded-md hover:bg-gray-200" data-char="δ">δ</button>
                <button class="px-2 py-1 text-sm bg-white border rounded-md hover:bg-gray-200" data-char="θ">θ</button>
                <button class="px-2 py-1 text-sm bg-white border rounded-md hover:bg-gray-200" data-char="π">π</button>
                <button class="px-2 py-1 text-sm bg-white border rounded-md hover:bg-gray-200" data-char="Σ">Σ</button>
                <button class="px-2 py-1 text-sm bg-white border rounded-md hover:bg-gray-200" data-char="Δ">Δ</button>
                <button class="px-2 py-1 text-sm bg-white border rounded-md hover:bg-gray-200" data-char="ε">ε</button>
                <button class="px-2 py-1 text-sm bg-white border rounded-md hover:bg-gray-200" data-char="√">√</button>
                <button class="px-2 py-1 text-sm bg-white border rounded-md hover:bg-gray-200" data-char="∞">∞</button>
                <button class="px-2 py-1 text-sm bg-white border rounded-md hover:bg-gray-200" data-char="∫">∫</button>
            </div>

            <textarea id="student-answer-input" rows="10" class="w-full p-4 border-2 border-gray-300 rounded-lg focus:border-indigo-500 focus:ring-indigo-500 transition duration-150 shadow-sm" placeholder="Tulis jawaban esai Anda di sini..."></textarea>
        </section>

        <!-- Tombol Aksi -->
        <div class="flex flex-col md:flex-row gap-4 mb-8">
            <button id="submit-answer-btn" class="flex-1 bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg transition duration-300 transform hover:scale-[1.02] disabled:opacity-50" disabled>
                <span id="submit-text">Kirim Jawaban & Nilai</span>
            </button>
            <button id="retake-quiz-btn" class="flex-1 bg-gray-400 hover:bg-gray-500 text-white font-bold py-3 px-6 rounded-lg shadow-lg transition duration-300 transform hover:scale-[1.02] disabled:opacity-50" disabled>
                Ulangi Ujian
            </button>
        </div>

        <!-- Area Hasil & Penilaian -->
        <section id="results-area" class="hidden mt-8 border-t pt-6">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Hasil Penilaian</h2>
            
            <!-- Skor dan Status -->
            <div class="flex flex-col md:flex-row gap-4 mb-6">
                <div class="flex-1 p-5 bg-blue-100 border border-blue-300 rounded-xl shadow-md">
                    <p class="text-sm font-medium text-blue-700">Skor Anda:</p>
                    <p id="score-display" class="text-4xl font-extrabold text-blue-900 mt-1">--</p>
                </div>
                <div class="flex-1 p-5 bg-yellow-100 border border-yellow-300 rounded-xl shadow-md">
                    <p class="text-sm font-medium text-yellow-700">Waktu Pengerjaan:</p>
                    <p id="time-display" class="text-4xl font-extrabold text-yellow-900 mt-1">--</p>
                </div>
            </div>

            <!-- Umpan Balik Detail dari AI -->
            <div id="ai-feedback-container" class="mb-6 p-6 bg-white border border-gray-200 rounded-xl shadow-lg">
                <h3 class="text-xl font-semibold text-gray-700 mb-3 border-b pb-2">Umpan Balik Mendalam</h3>
                <div id="ai-feedback" class="prose-custom max-w-none text-gray-600">
                    <p>Umpan balik penilaian AI akan ditampilkan di sini.</p>
                </div>
            </div>

            <!-- Tombol Download -->
            <div class="text-right">
                <button id="download-pdf-btn" class="bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-300 transform hover:scale-105">
                    Download Hasil Ujian (PDF)
                </button>
            </div>
        </section>
    </main>

    <!-- Modal Pengaturan Guru (ADMIN ONLY) -->
    <div id="settings-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 transition-opacity duration-300">
        <!-- Backdrop for pin check -->
        <div id="settings-backdrop" class="absolute inset-0"></div>

        <!-- Konten Modal Utama -->
        <div id="settings-modal-content-wrapper" class="bg-white rounded-xl shadow-2xl w-full max-w-3xl m-4 transition-transform duration-300 transform scale-95 opacity-0">
            
            <!-- Cek PIN Awal -->
            <div id="pin-check-screen" class="p-6">
                <h2 class="text-2xl font-bold mb-4 text-gray-800">Akses Pengaturan Guru</h2>
                <p class="mb-4 text-gray-600">Masukkan PIN Admin untuk mengakses konfigurasi.</p>
                <input type="password" id="pin-input" class="w-full p-3 mb-4 border-2 border-indigo-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" maxlength="4" placeholder="PIN 4 Digit">
                <div class="flex justify-end space-x-3">
                    <button id="close-settings-btn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 px-4 rounded-lg transition duration-150">Batal</button>
                    <button id="submit-pin-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-150 disabled:opacity-50" disabled>Masuk</button>
                </div>
            </div>

            <!-- Konten Pengaturan Setelah Lolos PIN -->
            <div id="settings-config-screen" class="hidden p-6">
                <div class="flex justify-between items-center border-b pb-3 mb-4">
                    <h2 class="text-2xl font-bold text-gray-800">Konfigurasi Aplikasi</h2>
                    <button id="close-config-btn" class="text-gray-500 hover:text-gray-700 text-2xl font-semibold">&times;</button>
                </div>

                <!-- Navigasi Tab -->
                <div class="flex border-b mb-6">
                    <button id="tab-config-btn" class="tab-btn active px-4 py-2 text-sm font-medium border-b-2 border-indigo-600 text-indigo-600 hover:text-indigo-800 transition duration-150">Konfigurasi</button>
                    <button id="tab-generator-btn" class="tab-btn px-4 py-2 text-sm font-medium text-gray-600 hover:text-indigo-600 transition duration-150">Generator Soal</button>
                    <button id="tab-link-gen-btn" class="tab-btn px-4 py-2 text-sm font-medium text-gray-600 hover:text-indigo-600 transition duration-150">Generator Link</button>
                </div>
                
                <!-- Konten Tab -->
                <div id="settings-modal-content">

                    <!-- Tab 1: Konfigurasi Dasar -->
                    <div id="config-tab-content" class="tab-content active p-4 space-y-4 border rounded-lg bg-gray-50 transition-all duration-300">
                        <h3 class="text-lg font-semibold text-gray-700">Pengaturan Akses & API</h3>
                        
                        <!-- Input PIN Admin -->
                        <div class="space-y-2">
                            <label for="admin-pin-input" class="block text-sm font-medium text-gray-700">PIN Admin (4 digit angka)</label>
                            <input type="password" id="admin-pin-input" class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" maxlength="4" placeholder="Contoh: 1234">
                            <p class="text-xs text-gray-500 mt-1">Gunakan PIN ini untuk mengakses Pengaturan Guru di masa mendatang.</p>
                        </div>
                        
                        <!-- START: Input URL Skrip API (BARU) -->
                        <div class="space-y-2">
                            <label for="url-script-input" class="block text-sm font-medium text-gray-700">URL Skrip API (Wajib)</label>
                            <input type="url" id="url-script-input" class="w-full p-2 border border-gray-300 rounded-md focus:ring-red-500 focus:border-red-500" placeholder="Contoh: https://script.google.com/macros/s/ABC/exec">
                            <p class="text-xs text-gray-500 mt-1">Ini adalah URL API yang digunakan untuk menghasilkan soal dan memberi nilai jawaban.</p>
                        </div>
                        <!-- END: Input URL Skrip API (BARU) -->
                    </div>

                    <!-- Tab 2: Generator Soal -->
                    <div id="generator-tab-content" class="tab-content p-4 space-y-4 border rounded-lg bg-gray-50 transition-all duration-300">
                        <h3 class="text-lg font-semibold text-gray-700">Buat Soal Ujian Baru</h3>
                        <div class="space-y-2">
                            <label for="topic-input" class="block text-sm font-medium text-gray-700">Topik Soal</label>
                            <input type="text" id="topic-input" class="w-full p-2 border border-gray-300 rounded-md" placeholder="Contoh: Hukum Newton tentang Gerak">
                        </div>
                        <div class="space-y-2">
                            <label for="level-select" class="block text-sm font-medium text-gray-700">Tingkat Kesulitan</label>
                            <select id="level-select" class="w-full p-2 border border-gray-300 rounded-md">
                                <option value="SMP">SMP (Mudah)</option>
                                <option value="SMA" selected>SMA (Sedang)</option>
                                <option value="Universitas">Universitas (Sulit)</option>
                            </select>
                        </div>
                        <div class="space-y-2">
                            <label for="context-input" class="block text-sm font-medium text-gray-700">Batasan/Kontek Tambahan (Opsional)</label>
                            <textarea id="context-input" rows="3" class="w-full p-2 border border-gray-300 rounded-md" placeholder="Contoh: Soal harus dalam konteks Biologi, fokus pada sistem pernapasan."></textarea>
                        </div>
                        <button id="generate-questions-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-150 shadow-md disabled:opacity-50">
                            <span id="generator-btn-text">Buat Soal</span>
                        </button>
                    </div>

                    <!-- Tab 3: Generator Link (belum diimplementasikan dalam skrip ini, hanya UI) -->
                    <div id="link-gen-tab-content" class="tab-content p-4 space-y-4 border rounded-lg bg-gray-50 transition-all duration-300">
                        <h3 class="text-lg font-semibold text-gray-700">Bagikan Soal via Link</h3>
                        <p class="text-gray-600">Fitur ini memungkinkan Anda membagikan soal yang aktif (setelah dibuat di tab Generator Soal) melalui tautan unik.</p>
                        <button id="create-link-btn" class="w-full bg-orange-500 hover:bg-orange-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-150 shadow-md disabled:opacity-50" disabled>
                            Buat Link Soal
                        </button>
                        <div class="space-y-2 mt-4 hidden" id="link-display-container">
                            <label for="quiz-link-output" class="block text-sm font-medium text-gray-700">Tautan Soal Ujian:</label>
                            <div class="flex gap-2">
                                <input type="text" id="quiz-link-output" class="flex-grow p-2 border border-gray-300 rounded-md bg-white" readonly value="Tautan akan muncul di sini...">
                                <button id="copy-link-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-150">Salin</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="mt-6 border-t pt-4 text-right">
                    <button id="save-settings-btn" class="bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-6 rounded-lg transition duration-150 shadow-md">Simpan Pengaturan</button>
                </div>

            </div>
        </div>
    </div>

    <!-- Overlay Pesan (untuk alert custom) -->
    <div id="message-overlay" class="fixed inset-0 bg-black bg-opacity-70 hidden items-center justify-center z-[60] transition-opacity duration-300">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm m-4 p-6 space-y-4 transition-transform duration-300 transform scale-95 opacity-0">
            <h3 id="overlay-title" class="text-xl font-bold text-gray-800">Pesan</h3>
            <p id="overlay-text" class="text-gray-600"></p>
            <div class="flex justify-end">
                <button id="overlay-close-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-150">Tutup</button>
            </div>
        </div>
    </div>

<script>
    const QUIZ_KEY = 'currentQuizQuestion';
    const ANSWER_KEY = 'studentAnswer';
    const PIN_KEY = 'adminPin';
    const URL_KEY = 'scriptUrl'; // Kunci baru untuk URL API
    const DEFAULT_PIN = '1234';

    // Global state
    let startTime = null;
    let quizQuestion = '';
    let adminPin = DEFAULT_PIN;
    let scriptUrl = ''; // Global variable untuk URL API

    // DOM Elements
    const quizQuestionDiv = document.getElementById('quiz-question');
    const studentAnswerInput = document.getElementById('student-answer-input');
    const submitAnswerBtn = document.getElementById('submit-answer-btn');
    const retakeQuizBtn = document.getElementById('retake-quiz-btn');
    const resultsArea = document.getElementById('results-area');
    const scoreDisplay = document.getElementById('score-display');
    const timeDisplay = document.getElementById('time-display');
    const aiFeedbackDiv = document.getElementById('ai-feedback');
    const downloadPdfBtn = document.getElementById('download-pdf-btn');

    // Settings Modal DOM
    const settingsModal = document.getElementById('settings-modal');
    const teacherSettingsBtn = document.getElementById('teacher-settings-btn');
    const settingsBackdrop = document.getElementById('settings-backdrop');
    const closeSettingsBtn = document.getElementById('close-settings-btn');
    const closeConfigBtn = document.getElementById('close-config-btn');
    const pinCheckScreen = document.getElementById('pin-check-screen');
    const settingsConfigScreen = document.getElementById('settings-config-screen');
    const pinInput = document.getElementById('pin-input');
    const submitPinBtn = document.getElementById('submit-pin-btn');
    const saveSettingsBtn = document.getElementById('save-settings-btn');
    const adminPinInput = document.getElementById('admin-pin-input');
    const urlScriptInput = document.getElementById('url-script-input'); // DOM Baru

    // Tab Buttons & Content
    const tabConfigBtn = document.getElementById('tab-config-btn');
    const tabGeneratorBtn = document.getElementById('tab-generator-btn');
    const tabLinkGenBtn = document.getElementById('tab-link-gen-btn');
    const tabContents = document.querySelectorAll('.tab-content');

    // Generator Tab DOM
    const topicInput = document.getElementById('topic-input');
    const levelSelect = document.getElementById('level-select');
    const contextInput = document.getElementById('context-input');
    const generateQuestionsBtn = document.getElementById('generate-questions-btn');
    const generatorBtnText = document.getElementById('generator-btn-text');

    // Overlay Message DOM
    const messageOverlay = document.getElementById('message-overlay');
    const overlayTitle = document.getElementById('overlay-title');
    const overlayText = document.getElementById('overlay-text');
    const overlayCloseBtn = document.getElementById('overlay-close-btn');

    // Link Generator DOM
    const createLinkBtn = document.getElementById('create-link-btn');
    const copyLinkBtn = document.getElementById('copy-link-btn');
    const linkDisplayContainer = document.getElementById('link-display-container');
    const quizLinkOutput = document.getElementById('quiz-link-output');

    /**
     * UTILITY FUNCTIONS
     */

    // Menampilkan Overlay Pesan Kustom
    function showOverlayMessage(title, message, type = 'info') {
        overlayTitle.textContent = title;
        overlayText.textContent = message;
        
        // Atur warna berdasarkan tipe pesan
        overlayTitle.classList.remove('text-green-700', 'text-red-700');
        if (type === 'success') {
            overlayTitle.classList.add('text-green-700');
        } else if (type === 'error') {
            overlayTitle.classList.add('text-red-700');
        } else {
            overlayTitle.classList.add('text-indigo-600');
        }

        messageOverlay.classList.remove('hidden');
        messageOverlay.classList.add('flex');
        // Animasi masuk
        const contentWrapper = messageOverlay.querySelector('div');
        setTimeout(() => {
            contentWrapper.classList.remove('scale-95', 'opacity-0');
            contentWrapper.classList.add('scale-100', 'opacity-100');
        }, 10);
    }

    // Menutup Overlay Pesan Kustom
    function closeOverlayMessage() {
        const contentWrapper = messageOverlay.querySelector('div');
        contentWrapper.classList.remove('scale-100', 'opacity-100');
        contentWrapper.classList.add('scale-95', 'opacity-0');
        setTimeout(() => {
            messageOverlay.classList.add('hidden');
            messageOverlay.classList.remove('flex');
        }, 300);
    }


    /**
     * FIREBASE & API FUNCTIONS
     */
    
    // Fungsi untuk memanggil Google Script API
    async function callApi(action, data) {
        if (!scriptUrl) {
            showOverlayMessage("Kesalahan Konfigurasi", "URL Skrip API belum diatur. Silakan atur di Pengaturan Guru > Konfigurasi.", "error");
            return { error: true, message: 'Script URL not configured.' };
        }

        const payload = { action, ...data };

        try {
            const response = await fetch(scriptUrl, {
                method: 'POST',
                mode: 'cors',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(payload),
            });

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            return await response.json();
        } catch (error) {
            console.error('API Call Error:', error);
            showOverlayMessage("Kesalahan Jaringan/API", `Gagal menghubungi server: ${error.message}. Pastikan URL Skrip API sudah benar.`, "error");
            return { error: true, message: error.message };
        }
    }

    /**
     * CORE QUIZ FUNCTIONS
     */

    // Muat Soal dan Jawaban dari Local Storage
    function loadQuiz() {
        const savedQuiz = localStorage.getItem(QUIZ_KEY);
        const savedAnswer = localStorage.getItem(ANSWER_KEY);

        if (savedQuiz) {
            const quizData = JSON.parse(savedQuiz);
            quizQuestion = quizData.question || '';
            startTime = quizData.startTime ? new Date(quizData.startTime) : new Date();

            quizQuestionDiv.innerHTML = quizQuestion;
            
            if (quizQuestion) {
                // Ada soal, aktifkan input dan tombol kirim
                studentAnswerInput.removeAttribute('disabled');
                submitAnswerBtn.removeAttribute('disabled');
                retakeQuizBtn.setAttribute('disabled', 'true');
            }
            
            if (savedAnswer) {
                // Jawaban sudah dikirim (berarti sudah dinilai)
                const answerData = JSON.parse(savedAnswer);
                studentAnswerInput.value = answerData.answer;
                studentAnswerInput.setAttribute('disabled', 'true');
                submitAnswerBtn.setAttribute('disabled', 'true');
                retakeQuizBtn.removeAttribute('disabled');
                
                displayResults(answerData.score, answerData.feedback, answerData.timeTaken);
            } else {
                // Belum dinilai, pastikan hasil tersembunyi
                resultsArea.classList.add('hidden');
            }
        } else {
            // Belum ada soal, tampilkan pesan default
            quizQuestionDiv.innerHTML = '<p>Silakan tekan tombol **Pengaturan Guru** untuk membuat soal ujian baru.</p>';
            studentAnswerInput.setAttribute('disabled', 'true');
            submitAnswerBtn.setAttribute('disabled', 'true');
            retakeQuizBtn.setAttribute('disabled', 'true');
        }
    }

    // Kirim Jawaban dan Nilai
    async function submitAnswer() {
        const studentAnswer = studentAnswerInput.value.trim();
        if (studentAnswer.length < 50) {
            showOverlayMessage("Jawaban Terlalu Pendek", "Jawaban esai Anda harus minimal 50 karakter.", "info");
            return;
        }

        // Hitung waktu pengerjaan
        const endTime = new Date();
        const timeTakenMs = endTime - startTime;
        const seconds = Math.floor(timeTakenMs / 1000);
        const minutes = Math.floor(seconds / 60);
        const remainingSeconds = seconds % 60;
        const timeTakenFormatted = `${minutes}m ${remainingSeconds}s`;

        // Tampilkan loading
        submitAnswerBtn.setAttribute('disabled', 'true');
        submitAnswerBtn.querySelector('#submit-text').innerHTML = 'Menilai<span class="loading-dots"></span>';
        studentAnswerInput.setAttribute('disabled', 'true');

        const apiData = {
            question: quizQuestion,
            answer: studentAnswer,
            level: 'SMA' // Asumsi level default, bisa diatur lebih lanjut
        };

        const result = await callApi('gradeEssay', apiData);

        // Hentikan loading
        submitAnswerBtn.querySelector('#submit-text').textContent = 'Kirim Jawaban & Nilai';

        if (result && !result.error && result.score !== undefined) {
            const score = result.score;
            const feedback = result.feedback || 'Tidak ada umpan balik yang disediakan.';
            
            // Simpan hasil penilaian
            const answerData = {
                answer: studentAnswer,
                score: score,
                feedback: feedback,
                timeTaken: timeTakenFormatted
            };
            localStorage.setItem(ANSWER_KEY, JSON.stringify(answerData));

            displayResults(score, feedback, timeTakenFormatted);

            submitAnswerBtn.setAttribute('disabled', 'true');
            retakeQuizBtn.removeAttribute('disabled');
            showOverlayMessage("Penilaian Selesai", `Skor Anda: ${score}/100`, "success");

        } else if (result.message && result.message === 'Script URL not configured.') {
             // Do nothing, showOverlayMessage already called in callApi
             // Re-enable input if API call failed due to configuration
             studentAnswerInput.removeAttribute('disabled');
        } else {
            // Gagal penilaian
            studentAnswerInput.removeAttribute('disabled');
            showOverlayMessage("Gagal Menilai", "Terjadi kesalahan saat menghubungi API penilaian.", "error");
        }
    }

    // Tampilkan Hasil
    function displayResults(score, feedback, timeTaken) {
        scoreDisplay.textContent = `${score}/100`;
        timeDisplay.textContent = timeTaken;
        aiFeedbackDiv.innerHTML = feedback; // Diasumsikan feedback sudah dalam format HTML/Markdown
        resultsArea.classList.remove('hidden');
        // Geser ke area hasil
        resultsArea.scrollIntoView({ behavior: 'smooth' });
    }

    // Ulangi Ujian (Reset Local Storage)
    function retakeQuiz() {
        localStorage.removeItem(ANSWER_KEY);
        localStorage.removeItem(QUIZ_KEY); // Hapus soal juga agar bisa mulai dari awal
        loadQuiz();
        resultsArea.classList.add('hidden');
        studentAnswerInput.value = '';
        showOverlayMessage("Ujian Direset", "Soal dan jawaban Anda telah direset. Silakan buat soal baru di Pengaturan Guru.", "info");
    }

    /**
     * SETTINGS MODAL FUNCTIONS
     */

    // Muat Pengaturan dari Local Storage
    function loadSettings() {
        const savedPin = localStorage.getItem(PIN_KEY);
        if (savedPin) {
            adminPin = savedPin;
        }
        adminPinInput.value = adminPin;
        
        // MUAT URL SKRIP API BARU
        const savedUrl = localStorage.getItem(URL_KEY);
        if (savedUrl) {
            scriptUrl = savedUrl;
            urlScriptInput.value = savedUrl;
        } else {
            scriptUrl = '';
            urlScriptInput.value = '';
        }

        // Tampilkan peringatan jika URL belum disetel
        if (!scriptUrl) {
            console.warn("URL Skrip API belum diatur!");
        }
    }

    // Simpan Pengaturan ke Local Storage
    function saveSettings() {
        // Simpan PIN
        const newPin = adminPinInput.value.trim();
        if (newPin && /^\d{4}$/.test(newPin)) {
            localStorage.setItem(PIN_KEY, newPin);
            adminPin = newPin;
            showOverlayMessage("Pengaturan Disimpan", "PIN Admin berhasil diperbarui.", "success");
        } else {
            showOverlayMessage("Kesalahan PIN", "PIN Admin harus 4 digit angka.", "error");
            return;
        }

        // Simpan URL Skrip API (BARU)
        const newScriptUrl = urlScriptInput.value.trim();
        localStorage.setItem(URL_KEY, newScriptUrl);
        scriptUrl = newScriptUrl;

        if (!newScriptUrl) {
            showOverlayMessage("Peringatan", "Anda belum mengatur URL Skrip API. Generator Soal tidak akan berfungsi.", "info");
        } else {
            // Jika berhasil, tutup modal
            closeSettingsModal();
        }
    }

    // Buka Modal Pengaturan Guru
    function openSettingsModal() {
        // Reset tampilan modal ke layar PIN
        pinCheckScreen.classList.remove('hidden');
        settingsConfigScreen.classList.add('hidden');
        pinInput.value = '';
        submitPinBtn.setAttribute('disabled', 'true');
        
        // Reset tab ke Konfigurasi
        switchTab('config');
        
        settingsModal.classList.remove('hidden');
        settingsModal.classList.add('flex');
        
        // Animasi masuk
        const contentWrapper = document.getElementById('settings-modal-content-wrapper');
        setTimeout(() => {
            contentWrapper.classList.remove('scale-95', 'opacity-0');
            contentWrapper.classList.add('scale-100', 'opacity-100');
            pinInput.focus();
        }, 10);
    }

    // Tutup Modal Pengaturan Guru
    function closeSettingsModal() {
        const contentWrapper = document.getElementById('settings-modal-content-wrapper');
        contentWrapper.classList.remove('scale-100', 'opacity-100');
        contentWrapper.classList.add('scale-95', 'opacity-0');
        setTimeout(() => {
            settingsModal.classList.add('hidden');
            settingsModal.classList.remove('flex');
        }, 300);
    }

    // Cek PIN Admin
    function checkPin() {
        if (pinInput.value === adminPin) {
            pinCheckScreen.classList.add('hidden');
            settingsConfigScreen.classList.remove('hidden');
            loadSettings(); // Muat pengaturan saat masuk
        } else {
            pinInput.classList.add('border-red-500');
            showOverlayMessage("Akses Ditolak", "PIN Admin salah. Silakan coba lagi.", "error");
            setTimeout(() => pinInput.classList.remove('border-red-500'), 1000);
        }
    }

    // Navigasi Tab
    function switchTab(tabId) {
        // Hapus kelas aktif dari semua tombol dan konten
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.classList.remove('active', 'border-indigo-600', 'text-indigo-600');
            btn.classList.add('text-gray-600');
        });
        tabContents.forEach(content => {
            content.classList.remove('active');
        });

        // Tambahkan kelas aktif ke tab yang dipilih
        const selectedBtn = document.getElementById(`tab-${tabId}-btn`);
        const selectedContent = document.getElementById(`${tabId}-tab-content`);
        
        if (selectedBtn && selectedContent) {
            selectedBtn.classList.add('active', 'border-indigo-600', 'text-indigo-600');
            selectedBtn.classList.remove('text-gray-600');
            selectedContent.classList.add('active');
        }
    }


    /**
     * QUESTION GENERATOR FUNCTIONS
     */

    async function generateQuestions() {
        // PENTING: Periksa URL Skrip API
        if (!scriptUrl) {
            showOverlayMessage("Kesalahan Konfigurasi", "URL Skrip API belum diatur. Silakan atur di Pengaturan Guru > Konfigurasi.", "error");
            return;
        }

        const topic = topicInput.value.trim();
        const level = levelSelect.value;
        const context = contextInput.value.trim();

        if (!topic) {
            showOverlayMessage("Input Kurang", "Mohon masukkan Topik Soal.", "info");
            return;
        }

        // Tampilkan loading
        generateQuestionsBtn.setAttribute('disabled', 'true');
        generatorBtnText.innerHTML = 'Membuat Soal<span class="loading-dots"></span>';

        const apiData = {
            topic: topic,
            level: level,
            context: context
        };

        const result = await callApi('generateQuiz', apiData);

        // Hentikan loading
        generatorBtnText.textContent = 'Buat Soal';
        generateQuestionsBtn.removeAttribute('disabled');

        if (result && !result.error && result.question) {
            quizQuestion = result.question;
            startTime = new Date();
            
            // Simpan soal baru ke local storage
            localStorage.setItem(QUIZ_KEY, JSON.stringify({
                question: quizQuestion,
                startTime: startTime.toISOString()
            }));
            localStorage.removeItem(ANSWER_KEY); // Reset jawaban lama
            
            loadQuiz(); // Muat soal baru ke UI utama
            closeSettingsModal();
            showOverlayMessage("Soal Baru Dibuat", "Soal ujian baru telah berhasil dibuat dan dimuat.", "success");

        } else if (result.message && result.message === 'Script URL not configured.') {
             // Do nothing, showOverlayMessage already called in callApi
        } else {
            showOverlayMessage("Gagal Membuat Soal", "Terjadi kesalahan saat menghubungi API generator soal.", "error");
        }
    }


    /**
     * LINK GENERATOR FUNCTIONS (Placeholder)
     */
    function createLink() {
        showOverlayMessage("Fitur Belum Tersedia", "Generator Link belum diimplementasikan. Harap buat soal secara manual untuk saat ini.", "info");
        linkDisplayContainer.classList.remove('hidden');
        quizLinkOutput.value = "https://example.com/quiz?q=" + btoa(quizQuestion.substring(0, 50));
    }

    function copyLink() {
        quizLinkOutput.select();
        document.execCommand('copy');
        showOverlayMessage("Berhasil Disalin", "Tautan soal ujian telah disalin ke clipboard.", "success");
    }


    /**
     * PDF GENERATOR
     */
    function downloadResultsAsPDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF('p', 'mm', 'a4');
        const MARGIN = 15;
        let y = MARGIN;
        const LINE_HEIGHT = 7;
        
        doc.setFont('Inter', 'bold');
        doc.setFontSize(16);
        doc.text('Laporan Hasil Ujian Esai AI', MARGIN, y);
        y += LINE_HEIGHT;

        doc.setFont('Inter', 'normal');
        doc.setFontSize(10);
        doc.text(`Tanggal Ujian: ${new Date().toLocaleDateString('id-ID')}`, MARGIN, y);
        y += LINE_HEIGHT;
        doc.text(`Waktu Pengerjaan: ${timeDisplay.textContent}`, MARGIN, y);
        y += LINE_HEIGHT * 2;

        // Skor
        doc.setFont('Inter', 'bold');
        doc.setFontSize(14);
        doc.text(`SKOR AKHIR: ${scoreDisplay.textContent}`, MARGIN, y);
        y += LINE_HEIGHT * 2;

        // Soal
        doc.setFont('Inter', 'bold');
        doc.setFontSize(12);
        doc.text('Soal Ujian:', MARGIN, y);
        y += LINE_HEIGHT;
        doc.setFont('Inter', 'normal');
        doc.setFontSize(10);
        const questionLines = doc.splitTextToSize(quizQuestionDiv.textContent, 180);
        doc.text(questionLines, MARGIN, y);
        y += questionLines.length * LINE_HEIGHT + LINE_HEIGHT;

        // Jawaban Siswa
        doc.setFont('Inter', 'bold');
        doc.setFontSize(12);
        doc.text('Jawaban Siswa:', MARGIN, y);
        y += LINE_HEIGHT;
        doc.setFont('Inter', 'normal');
        doc.setFontSize(10);
        const answerLines = doc.splitTextToSize(studentAnswerInput.value, 180);
        doc.text(answerLines, MARGIN, y);
        y += answerLines.length * LINE_HEIGHT + LINE_HEIGHT;

        // Umpan Balik AI (Menggunakan HTML2Canvas untuk rendering visual)
        html2canvas(aiFeedbackContainer, { scale: 2 }).then(canvas => {
            const imgData = canvas.toDataURL('image/png');
            const imgWidth = 180;
            const imgHeight = canvas.height * imgWidth / canvas.width;

            if (y + imgHeight > 280) { // Cek batas bawah halaman A4
                doc.addPage();
                y = MARGIN;
            }

            doc.setFont('Inter', 'bold');
            doc.setFontSize(12);
            doc.text('Umpan Balik Mendalam:', MARGIN, y);
            y += LINE_HEIGHT;
            
            doc.addImage(imgData, 'PNG', MARGIN, y, imgWidth, imgHeight);
            
            doc.save('Hasil_Ujian_Esai.pdf');
        });
    }

    /**
     * EVENT LISTENERS AND INITIALIZATION
     */
    document.addEventListener('DOMContentLoaded', () => {
        // Load settings and quiz data on startup
        loadSettings();
        loadQuiz();

        // Overlay Message Event
        overlayCloseBtn.addEventListener('click', closeOverlayMessage);

        // Input validation for PIN
        pinInput.addEventListener('input', () => {
            submitPinBtn.disabled = pinInput.value.length !== 4 || !/^\d+$/.test(pinInput.value);
        });

        // Core Quiz Actions
        submitAnswerBtn.addEventListener('click', submitAnswer);
        retakeQuizBtn.addEventListener('click', retakeQuiz);
        downloadPdfBtn.addEventListener('click', downloadResultsAsPDF);
        
        // Pengaturan Guru
        teacherSettingsBtn.addEventListener('click', openSettingsModal);
        settingsBackdrop.addEventListener('click', closeSettingsModal);
        closeSettingsBtn.addEventListener('click', closeSettingsModal);
        closeConfigBtn.addEventListener('click', closeSettingsModal);
        submitPinBtn.addEventListener('click', checkPin);
        saveSettingsBtn.addEventListener('click', saveSettings);

        // Navigasi Tab
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const tabId = btn.id.split('-')[1]; // config, generator, link
                switchTab(tabId);
            });
        });
        
        // Generator Soal
        generateQuestionsBtn.addEventListener('click', generateQuestions);
        
        // Generator Link (Placeholder)
        createLinkBtn.addEventListener('click', createLink);
        copyLinkBtn.addEventListener('click', copyLink);

        // Toolbar
        document.getElementById('writing-toolbar').addEventListener('click', (e) => {
            if (e.target.tagName === 'BUTTON' && e.target.dataset.char) {
                insertAtCursor(studentAnswerInput, e.target.dataset.char);
            }
        });

        // Fungsi untuk menyisipkan karakter pada posisi kursor
        function insertAtCursor(el, text) {
            const start = el.selectionStart;
            const end = el.selectionEnd;
            const value = el.value;
            el.value = value.substring(0, start) + text + value.substring(end);
            // Pindahkan kursor setelah karakter yang disisipkan
            el.selectionStart = el.selectionEnd = start + text.length;
            el.focus();
        }
    });
</script>
</body>
</html>
