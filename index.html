<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplikasi Ujian Esai AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- jspdf dan html2canvas untuk PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .prose-custom { max-width: none; }
        .prose-custom p { margin-top: 0.5em; margin-bottom: 0.5em; }
        .prose-custom h3 { margin-bottom: 0.5em; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }

        /* Custom style for active tab button */
        .tab-button.active {
            border-bottom-width: 2px;
            border-color: #2563eb; /* blue-600 */
            color: #2563eb; /* blue-600 */
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <!-- Header / Navbar -->
    <header class="bg-white shadow-md p-4 flex justify-between items-center z-20">
        <h1 class="text-xl font-bold text-gray-800">Ujian Esai Interaktif</h1>
        <div class="flex items-center space-x-3">
            <button id="teacher-settings-btn" class="bg-indigo-600 text-white px-3 py-1 rounded-lg hover:bg-indigo-700 text-sm transition duration-150">
                Pengaturan Guru
            </button>
        </div>
    </header>

    <!-- Main Content Area -->
    <main class="flex-grow p-4 md:p-8">
        <div class="max-w-4xl mx-auto space-y-8">
            
            <!-- Message Area -->
            <div id="message-box" class="hidden p-4 rounded-lg text-sm transition-opacity duration-300 opacity-0"></div>

            <!-- Quiz Information and Input Form -->
            <div id="quiz-area" class="bg-white p-6 rounded-xl shadow-lg">
                <div id="quiz-header" class="mb-4">
                    <p class="text-sm font-medium text-gray-500">Mata Pelajaran: <span id="info-subject" class="font-semibold text-gray-700">Memuat...</span></p>
                    <p class="text-sm font-medium text-gray-500">Materi: <span id="info-material" class="font-semibold text-gray-700">Memuat...</span></p>
                    <p class="text-sm font-medium text-gray-500">Durasi: <span id="info-duration" class="font-semibold text-gray-700">--</span> menit</p>
                </div>

                <div id="initial-load-area">
                    <h2 class="text-2xl font-bold mb-4 text-center text-gray-800">Selamat Datang di Ujian Esai</h2>
                    <p class="text-center text-gray-600 mb-6">Silakan masukkan nama dan kelas Anda untuk memulai ujian.</p>
                    <div class="space-y-4">
                        <input type="text" id="student-name-input" class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500" placeholder="Nama Lengkap Siswa" required>
                        <!-- START: Tambah input Kelas -->
                        <input type="text" id="student-class-input" class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500" placeholder="Kelas (Contoh: IX A / 9A)" required>
                        <!-- END: Tambah input Kelas -->
                    </div>
                    <button id="start-quiz-btn" class="mt-4 w-full bg-blue-600 text-white font-semibold py-2 rounded-lg hover:bg-blue-700 transition duration-150" disabled>Mulai Ujian</button>
                </div>

                <!-- Question and Answer Area (Hidden initially) -->
                <div id="question-answer-area" class="hidden">
                    <div id="timer-display" class="text-xl font-bold text-red-600 mb-4 text-center"></div>

                    <h3 class="text-lg font-semibold mb-2 text-gray-700">Soal Ujian:</h3>
                    <div id="question-display" class="prose prose-custom max-w-full p-4 mb-4 border border-gray-200 rounded-lg bg-gray-50 text-gray-800" style="white-space: pre-wrap;">Memuat soal...</div>

                    <h3 class="text-lg font-semibold mb-2 text-gray-700">Jawaban Anda:</h3>
                    
                    <!-- Writing Toolbar -->
                    <div id="writing-toolbar" class="flex flex-wrap gap-2 p-2 bg-gray-100 rounded-t-lg border-b border-gray-200">
                        <button class="text-xs bg-white text-gray-700 p-1 rounded-md border hover:bg-gray-200" data-char="~">~</button>
                        <button class="text-xs bg-white text-gray-700 p-1 rounded-md border hover:bg-gray-200" data-char="^">^</button>
                        <button class="text-xs bg-white text-gray-700 p-1 rounded-md border hover:bg-gray-200" data-char="_">_</button>
                        <button class="text-xs bg-white text-gray-700 p-1 rounded-md border hover:bg-gray-200" data-char="<"><</button>
                        <button class="text-xs bg-white text-gray-700 p-1 rounded-md border hover:bg-gray-200" data-char=">">></button>
                        <button class="text-xs bg-white text-gray-700 p-1 rounded-md border hover:bg-gray-200" data-char="/">/</button>
                        <button class="text-xs bg-white text-gray-700 p-1 rounded-md border hover:bg-gray-200" data-char="\">\</button>
                        <button class="text-xs bg-white text-gray-700 p-1 rounded-md border hover:bg-gray-200" data-char="(">(</button>
                        <button class="text-xs bg-white text-gray-700 p-1 rounded-md border hover:bg-gray-200" data-char=")">)</button>
                        <button class="text-xs bg-white text-gray-700 p-1 rounded-md border hover:bg-gray-200" data-char="[">[</button>
                        <button class="text-xs bg-white text-gray-700 p-1 rounded-md border hover:bg-gray-200" data-char="]">]</button>
                        <button class="text-xs bg-white text-gray-700 p-1 rounded-md border hover:bg-gray-200" data-char="{">{</button>
                        <button class="text-xs bg-white text-gray-700 p-1 rounded-md border hover:bg-gray-200" data-char="}">}</button>
                    </div>

                    <textarea id="student-answer-input" rows="10" class="w-full px-4 py-2 border border-gray-300 rounded-b-lg shadow-sm focus:ring-blue-500 focus:border-blue-500" placeholder="Tulis jawaban esai Anda di sini..."></textarea>
                    
                    <button id="submit-answer-btn" class="mt-4 w-full bg-green-600 text-white font-semibold py-2 rounded-lg hover:bg-green-700 transition duration-150">Selesaikan Ujian & Nilai Jawaban</button>
                </div>
            </div>
            
            <!-- Result Area (Hidden initially) -->
            <div id="result-area" class="hidden bg-white p-6 rounded-xl shadow-lg">
                <h2 class="text-2xl font-bold mb-4 text-center text-gray-800">Hasil Penilaian Ujian</h2>
                
                <div id="score-summary" class="bg-blue-50 p-4 rounded-lg mb-6 border-l-4 border-blue-600">
                    <p class="text-lg font-medium text-gray-800">Nama Siswa: <span id="result-student-name" class="font-bold"></span></p>
                    <!-- START: Tampilkan Kelas di Hasil -->
                    <p class="text-lg font-medium text-gray-800">Kelas: <span id="result-student-class" class="font-bold"></span></p>
                    <!-- END: Tampilkan Kelas di Hasil -->
                    <p class="text-lg font-medium text-gray-800">Skor Rata-rata: <span id="result-average-score" class="font-bold text-blue-600">--</span></p>
                    <p class="text-sm text-gray-600 mt-2">Penilaian ini bersifat otomatis menggunakan model AI. Harap tinjau kembali.</p>
                </div>
                
                <div id="result-details" class="space-y-4">
                    <!-- Detail hasil penilaian akan dimasukkan di sini oleh JS -->
                </div>
                
                <div class="mt-6 flex justify-between space-x-4">
                    <button id="download-pdf-btn" class="bg-red-600 text-white font-semibold px-4 py-2 rounded-lg hover:bg-red-700 transition duration-150 flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L10 11.586l2.293-2.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" /><path fill-rule="evenodd" d="M10 2a1 1 0 011 1v7a1 1 0 11-2 0V3a1 1 0 011-1z" clip-rule="evenodd" /></svg>
                        Unduh PDF
                    </button>
                    <button id="retake-quiz-btn" class="bg-gray-300 text-gray-800 font-semibold px-4 py-2 rounded-lg hover:bg-gray-400 transition duration-150">
                        Ulangi Ujian
                    </button>
                </div>
            </div>

        </div>
    </main>

    <!-- Settings Modal (Hidden initially) -->
    <div id="settings-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div id="settings-backdrop" class="absolute inset-0"></div>
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl p-6 relative z-10 mx-4" style="max-height: 90vh; overflow-y: auto;">
            <h2 class="text-2xl font-bold mb-4">Pengaturan Guru</h2>
            
            <!-- Close Button -->
            <button id="close-settings-btn-top" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
            </button>

            <!-- PIN Input Area (Default View) -->
            <div id="pin-input-area">
                <p class="text-gray-600 mb-4">Masukkan PIN untuk mengakses pengaturan. (PIN default: **1234**)</p>
                <input type="password" id="pin-input" class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 mb-4" placeholder="Masukkan PIN">
                <button id="submit-pin-btn" class="w-full bg-indigo-600 text-white font-semibold py-2 rounded-lg hover:bg-indigo-700 transition duration-150">Akses Pengaturan</button>
            </div>

            <!-- Settings Tabs Area (Hidden until PIN correct) -->
            <div id="settings-tabs-area" class="hidden">
                <!-- Tabs Navigation -->
                <div class="flex border-b mb-4">
                    <button id="tab-config-btn" class="tab-button active px-4 py-2 text-sm font-medium border-b-2 border-blue-600 text-blue-600 hover:text-blue-700 transition duration-150" data-tab="config">Konfigurasi</button>
                    <button id="tab-generator-btn" class="tab-button px-4 py-2 text-sm font-medium text-gray-500 hover:text-gray-700 transition duration-150" data-tab="generator">Generator Soal</button>
                    <button id="tab-link-gen-btn" class="tab-button px-4 py-2 text-sm font-medium text-gray-500 hover:text-gray-700 transition duration-150" data-tab="link-gen">Generator Link</button>
                </div>

                <!-- Tab Content Container -->
                <div id="tab-content-container">
                    
                    <!-- Konfigurasi Tab Content (Updated as requested) -->
                    <div id="tab-config-content" class="tab-content" style="display: block;">
                        <!-- Konten Tab Konfigurasi -->
                        <div class="space-y-4">
                            <div>
                                <label for="teacher-name" class="block text-sm font-medium text-gray-700">Nama Guru (untuk PDF)</label>
                                <input type="text" id="teacher-name" class="mt-1 w-full px-3 py-2 border rounded-md" placeholder="Contoh: Budi Santoso, S.Pd.">
                            </div>
                            <div>
                                <label for="config-exam-subject" class="block text-sm font-medium text-gray-700">Mata Pelajaran Ujian</label>
                                <input type="text" id="config-exam-subject" class="mt-1 w-full px-3 py-2 border rounded-md" placeholder="Contoh: Bahasa Indonesia">
                            </div>
                            <div>
                                <label for="config-exam-material" class="block text-sm font-medium text-gray-700">Materi Ujian</label>
                                <input type="text" id="config-exam-material" class="mt-1 w-full px-3 py-2 border rounded-md" placeholder="Contoh: Teks Prosedur">
                            </div>
                            <div>
                                <label for="config-exam-duration" class="block text-sm font-medium text-gray-700">Durasi Ujian (menit)</label>
                                <input type="number" id="config-exam-duration" class="mt-1 w-full px-3 py-2 border rounded-md" placeholder="Contoh: 90">
                            </div>
                            <div>
                                <label for="sheet-url" class="block text-sm font-medium text-gray-700">URL Google Sheet (Untuk Soal)</label>
                                <input type="text" id="sheet-url" class="mt-1 w-full px-3 py-2 border rounded-md" placeholder="https://docs.google.com/spreadsheets/d/.../edit">
                            </div>
                            <div>
                                <label for="apps-script-url" class="block text-sm font-medium text-gray-700">URL Google Apps Script (Hasil & Soal)</label>
                                <input type="text" id="apps-script-url" class="mt-1 w-full px-3 py-2 border rounded-md" placeholder="https://script.google.com/macros/s/.../exec">
                            </div>
                        </div>
                        <div class="mt-6 flex justify-end space-x-3">
                            <button id="save-settings-btn" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition duration-150">Simpan Pengaturan Lokal</button>
                        </div>
                    </div>
                    
                    <!-- Generator Tab Content (Placeholder) -->
                    <div id="tab-generator-content" class="tab-content p-4 border rounded-lg bg-gray-50" style="display: none;">
                        <h3 class="text-xl font-semibold mb-3">Generator Soal (Belum Aktif)</h3>
                        <p class="text-gray-600">Fitur ini akan memungkinkan Anda membuat soal esai baru menggunakan AI berdasarkan mata pelajaran dan materi yang Anda tentukan.</p>
                        <textarea id="generator-prompt" rows="4" class="w-full mt-3 px-3 py-2 border rounded-md" placeholder="Masukkan instruksi untuk soal esai (Contoh: Buatkan 3 soal esai tentang 'Teks Prosedur' untuk siswa kelas 7)."></textarea>
                        <button id="generate-questions-btn" class="mt-4 bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition duration-150 w-full">Generate Soal</button>
                    </div>

                    <!-- Link Generator Tab Content (Placeholder) -->
                    <div id="tab-link-gen-content" class="tab-content p-4 border rounded-lg bg-gray-50" style="display: none;">
                        <h3 class="text-xl font-semibold mb-3">Generator Link Ujian (Belum Aktif)</h3>
                        <p class="text-gray-600">Fitur ini akan menghasilkan URL ujian unik untuk dibagikan kepada siswa.</p>
                        <input type="text" id="exam-link-output" class="mt-3 w-full px-3 py-2 border rounded-md bg-gray-200" readonly placeholder="Link akan muncul di sini">
                        <div class="mt-4 flex space-x-3">
                            <button id="create-link-btn" class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition duration-150 flex-grow">Buat Link Ujian</button>
                            <button id="copy-link-btn" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition duration-150" disabled>Salin</button>
                        </div>
                    </div>
                </div>

                <div class="mt-6 flex justify-end">
                    <button id="close-settings-btn" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-400 transition duration-150">Tutup</button>
                </div>
            </div>
        </div>
    </div>

<script>
    // Konfigurasi default dan state
    const DEFAULT_PIN = "1234";
    let currentSettings = {};
    let quizState = {
        status: 'initial', // 'initial', 'in-progress', 'finished'
        question: null,
        studentName: '',
        studentClass: '', // Tambah state untuk Kelas Siswa
        startTime: null,
        timerInterval: null,
        elapsedTime: 0,
    };
    
    // --- Utils ---

    // Generic Message Box
    function showMessage(message, type = 'info') {
        const box = document.getElementById('message-box');
        box.textContent = message;
        box.className = `p-4 rounded-lg text-sm transition-opacity duration-300 opacity-100 mt-4`;
        
        if (type === 'error') {
            box.classList.add('bg-red-100', 'text-red-700');
        } else if (type === 'success') {
            box.classList.add('bg-green-100', 'text-green-700');
        } else { // info
            box.classList.add('bg-blue-100', 'text-blue-700');
        }

        box.style.display = 'block';
        setTimeout(() => {
            box.classList.remove('opacity-100');
            box.classList.add('opacity-0');
            setTimeout(() => box.style.display = 'none', 300);
        }, 5000);
    }
    
    // Timer functions
    function formatTime(seconds) {
        const mins = String(Math.floor(seconds / 60)).padStart(2, '0');
        const secs = String(seconds % 60).padStart(2, '0');
        return `${mins}:${secs}`;
    }

    function startTimer() {
        if (quizState.timerInterval) clearInterval(quizState.timerInterval);

        const totalSeconds = currentSettings.examDuration * 60;
        quizState.elapsedTime = 0;

        const timerDisplay = document.getElementById('timer-display');
        timerDisplay.textContent = formatTime(totalSeconds);

        quizState.timerInterval = setInterval(() => {
            quizState.elapsedTime++;
            const remainingTime = totalSeconds - quizState.elapsedTime;

            if (remainingTime <= 0) {
                clearInterval(quizState.timerInterval);
                timerDisplay.textContent = "WAKTU HABIS!";
                submitAnswer(true); // Auto submit when time is up
            } else {
                timerDisplay.textContent = formatTime(remainingTime);
            }
        }, 1000);
    }
    
    function stopTimer() {
        if (quizState.timerInterval) {
            clearInterval(quizState.timerInterval);
            quizState.timerInterval = null;
        }
    }

    // Function to insert character at cursor in textarea
    function insertAtCursor(textarea, char) {
        const start = textarea.selectionStart;
        const end = textarea.selectionEnd;
        const value = textarea.value;
        
        textarea.value = value.substring(0, start) + char + value.substring(end);
        textarea.selectionStart = textarea.selectionEnd = start + char.length;
        textarea.focus();
    }


    // --- Settings Functions ---

    function openSettingsModal() {
        document.getElementById('settings-modal').classList.remove('hidden');
        document.getElementById('pin-input-area').classList.remove('hidden');
        document.getElementById('settings-tabs-area').classList.add('hidden');
        document.getElementById('pin-input').value = '';
        document.getElementById('pin-input').focus();
    }

    function closeSettingsModal() {
        document.getElementById('settings-modal').classList.add('hidden');
    }

    function checkPin() {
        const pinInput = document.getElementById('pin-input').value;
        if (pinInput === DEFAULT_PIN) {
            document.getElementById('pin-input-area').classList.add('hidden');
            document.getElementById('settings-tabs-area').classList.remove('hidden');
            // Load settings into the form when settings area is opened
            loadSettings(); 
        } else {
            showMessage('PIN salah. Akses ditolak.', 'error');
            document.getElementById('pin-input').value = '';
        }
    }
    
    // Function to save settings to localStorage
    function saveSettings() {
        const teacherName = document.getElementById('teacher-name').value;
        const subject = document.getElementById('config-exam-subject').value;
        const material = document.getElementById('config-exam-material').value;
        const duration = document.getElementById('config-exam-duration').value;
        const sheetUrl = document.getElementById('sheet-url').value;
        const appsScriptUrl = document.getElementById('apps-script-url').value;
        
        // Validate required fields
        if (!sheetUrl || !appsScriptUrl) {
            showMessage('URL Google Sheet dan URL Apps Script wajib diisi.', 'error');
            return;
        }

        const settings = {
            teacherName: teacherName,
            examSubject: subject,
            examMaterial: material,
            examDuration: parseInt(duration) || 90, // Default to 90 minutes
            sheetUrl: sheetUrl,
            appsScriptUrl: appsScriptUrl,
        };

        localStorage.setItem('guruSettings', JSON.stringify(settings));
        showMessage('Pengaturan lokal berhasil disimpan!', 'success');
        
        // Update global settings and UI info
        currentSettings = settings;
        updateQuizHeaderInfo();
        
        closeSettingsModal();

        // Re-initialize quiz data if subject/material/sheet changed
        if (quizState.status === 'initial') {
            loadQuizData();
        }
    }

    // Function to load settings from localStorage
    function loadSettings() {
        const settingsString = localStorage.getItem('guruSettings');
        let settings;

        if (settingsString) {
            settings = JSON.parse(settingsString);
            
            // Update input fields in modal
            document.getElementById('teacher-name').value = settings.teacherName || '';
            document.getElementById('config-exam-subject').value = settings.examSubject || '';
            document.getElementById('config-exam-material').value = settings.examMaterial || '';
            document.getElementById('config-exam-duration').value = settings.examDuration || 90;
            document.getElementById('sheet-url').value = settings.sheetUrl || '';
            document.getElementById('apps-script-url').value = settings.appsScriptUrl || '';

            currentSettings = settings;

        } else {
            // Use default/empty settings if none found
            currentSettings = {
                teacherName: 'Nama Guru Anda',
                examSubject: 'Mata Pelajaran Ujian',
                examMaterial: 'Materi Ujian',
                examDuration: 90,
                sheetUrl: '',
                appsScriptUrl: '',
            };
        }
        updateQuizHeaderInfo();
    }
    
    function updateQuizHeaderInfo() {
        document.getElementById('info-subject').textContent = currentSettings.examSubject || 'Belum diatur';
        document.getElementById('info-material').textContent = currentSettings.examMaterial || 'Belum diatur';
        document.getElementById('info-duration').textContent = currentSettings.examDuration || '--';

        const startBtn = document.getElementById('start-quiz-btn');
        if (currentSettings.sheetUrl && currentSettings.appsScriptUrl) {
            startBtn.disabled = false;
        } else {
            startBtn.disabled = true;
            showMessage('Harap atur URL Google Sheet dan Apps Script di Pengaturan Guru (Pin: 1234) untuk memuat soal.', 'info');
        }
    }

    function switchTab(tabId) {
        const tabContents = document.querySelectorAll('.tab-content');
        const tabButtons = document.querySelectorAll('.tab-button');

        tabContents.forEach(content => {
            content.style.display = 'none';
        });

        tabButtons.forEach(button => {
            button.classList.remove('active', 'border-blue-600', 'text-blue-600');
            button.classList.add('text-gray-500', 'hover:text-gray-700');
        });

        document.getElementById(`tab-${tabId}-content`).style.display = 'block';
        document.getElementById(`tab-${tabId}-btn`).classList.add('active', 'border-blue-600', 'text-blue-600');
        document.getElementById(`tab-${tabId}-btn`).classList.remove('text-gray-500', 'hover:text-gray-700');
    }

    // --- Quiz Logic ---

    // Placeholder: This should fetch question from Google Sheet
    function loadQuizData() {
        if (!currentSettings.sheetUrl) return;

        // In a real scenario, this would involve a fetch request to Apps Script to get the question
        // For this demo, we use a placeholder question.
        document.getElementById('question-display').textContent = 'Memuat soal...';

        // Simulating data fetch
        setTimeout(() => {
            // Replace with actual data fetching logic
            quizState.question = {
                id: 1,
                text: "Jelaskan dengan detail langkah-langkah untuk membuat teh manis yang enak dan mengapa urutan langkah tersebut penting. (Minimal 3 paragraf)",
                gradingRubric: [
                    { criteria: "Kelengkapan dan Keterurutan Langkah", weight: 40 },
                    { criteria: "Kualitas Bahasa dan Kohesi Teks", weight: 30 },
                    { criteria: "Ketepatan Detail dan Alasan", weight: 30 }
                ]
            };
            document.getElementById('question-display').textContent = quizState.question.text;
            document.getElementById('start-quiz-btn').disabled = false;
        }, 1500);
    }


    function startQuiz() {
        const studentName = document.getElementById('student-name-input').value.trim();
        const studentClass = document.getElementById('student-class-input').value.trim(); // Ambil input kelas
        
        if (!studentName || !studentClass) { // Validasi nama dan kelas
            showMessage('Nama siswa dan Kelas wajib diisi.', 'error');
            return;
        }

        if (!quizState.question) {
            showMessage('Soal belum dimuat. Periksa Pengaturan dan coba lagi.', 'error');
            return;
        }

        quizState.studentName = studentName;
        quizState.studentClass = studentClass; // Simpan kelas ke state
        quizState.status = 'in-progress';
        quizState.startTime = new Date();
        document.getElementById('initial-load-area').classList.add('hidden');
        document.getElementById('question-answer-area').classList.remove('hidden');
        document.getElementById('student-answer-input').value = '';
        document.getElementById('student-answer-input').focus();
        
        startTimer();
    }

    // Placeholder: This should send data to an LLM and then save results
    async function submitAnswer(isTimeout = false) {
        stopTimer();
        const answer = document.getElementById('student-answer-input').value.trim();
        if (!answer) {
            showMessage('Jawaban tidak boleh kosong.', 'error');
            if (!isTimeout) startTimer(); // Resume timer if not timeout
            return;
        }

        if (!currentSettings.appsScriptUrl) {
            showMessage('URL Apps Script belum diatur. Harap atur di Pengaturan Guru.', 'error');
            if (!isTimeout) startTimer();
            return;
        }

        // Show loading state
        const submitBtn = document.getElementById('submit-answer-btn');
        const originalText = submitBtn.textContent;
        submitBtn.textContent = 'Menilai Jawaban... Harap Tunggu.';
        submitBtn.disabled = true;

        const systemPrompt = `Anda adalah seorang asisten penilaian akademik yang profesional dan ahli dalam menilai jawaban esai. Tugas Anda adalah memberikan penilaian yang rinci, spesifik, dan konstruktif.
            Instruksi:
            1. Nilai jawaban siswa ('${answer}') berdasarkan pertanyaan ('${quizState.question.text}') dan rubrik penilaian berikut:
            ${quizState.question.gradingRubric.map(r => `- ${r.criteria} (${r.weight}%)`).join('\n')}
            2. Berikan skor (angka 0-100) untuk setiap kriteria.
            3. Berikan *feedback* yang spesifik dan *actionable* (kurang dari 100 kata per kriteria).
            4. Hitung skor rata-rata tertimbang berdasarkan bobot kriteria.
            5. Output harus dalam format JSON yang spesifik.

            Struktur Output JSON yang HARUS Anda hasilkan:
            [
              {
                "kriteria": "[Kriteria 1 dari rubrik]",
                "bobot": [Bobot %],
                "skor": [Skor 0-100],
                "feedback": "[Ulasan singkat dan spesifik]"
              },
              {
                "kriteria": "[Kriteria 2 dari rubrik]",
                "bobot": [Bobot %],
                "skor": [Skor 0-100],
                "feedback": "[Ulasan singkat dan spesifik]"
              }
              // ... kriteria lainnya
            ]
        `;

        const payload = {
            contents: [{ parts: [{ text: "Lakukan penilaian esai berdasarkan prompt sistem." }] }],
            systemInstruction: { parts: [{ text: systemPrompt }] },
            generationConfig: {
                responseMimeType: "application/json",
                responseSchema: {
                    type: "ARRAY",
                    items: {
                        type: "OBJECT",
                        properties: {
                            "kriteria": { "type": "STRING" },
                            "bobot": { "type": "NUMBER" },
                            "skor": { "type": "NUMBER" },
                            "feedback": { "type": "STRING" }
                        },
                        "propertyOrdering": ["kriteria", "bobot", "skor", "feedback"]
                    }
                }
            }
        };

        let rawResult;
        try {
            const apiKey = ""; 
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            
            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            
            rawResult = await response.json();

            const jsonText = rawResult.candidates?.[0]?.content?.parts?.[0]?.text;
            if (!jsonText) throw new Error("Gagal mendapatkan respons JSON dari AI.");
            
            const results = JSON.parse(jsonText);
            
            if (!Array.isArray(results) || results.length === 0) throw new Error("Struktur JSON tidak valid.");

            // Calculate weighted average
            let totalWeightedScore = 0;
            let totalWeight = 0;
            results.forEach(item => {
                totalWeightedScore += item.skor * (item.bobot / 100);
                totalWeight += (item.bobot / 100);
            });
            const averageScore = Math.round((totalWeightedScore / totalWeight) * 100) / 100; // Round to 2 decimal places

            // Display results
            displayResults(results, averageScore, answer);

            // Save to Google Sheet
            await saveResultsToSheet(results, averageScore, answer);

        } catch (error) {
            console.error("Penilaian Gagal:", error);
            showMessage(`Penilaian gagal: ${error.message}. Cek koneksi atau coba lagi.`, 'error');
            // Re-enable timer and button on failure
            submitBtn.textContent = originalText;
            submitBtn.disabled = false;
            startTimer(); 
            return;
        } finally {
            submitBtn.textContent = originalText;
            submitBtn.disabled = false;
        }
    }
    
    // Function to display results on the page
    function displayResults(results, averageScore, answer) {
        document.getElementById('question-answer-area').classList.add('hidden');
        document.getElementById('result-area').classList.remove('hidden');
        document.getElementById('result-student-name').textContent = quizState.studentName;
        document.getElementById('result-student-class').textContent = quizState.studentClass; // Tampilkan Kelas
        document.getElementById('result-average-score').textContent = averageScore;

        const detailsArea = document.getElementById('result-details');
        detailsArea.innerHTML = `
            <div class="mb-6 p-4 border rounded-lg bg-yellow-50">
                <h4 class="font-bold text-gray-800 mb-2">Jawaban Siswa</h4>
                <div class="prose prose-custom text-sm text-gray-700 whitespace-pre-wrap">${answer}</div>
            </div>
            <h3 class="text-xl font-bold mb-3 text-gray-800">Detail Penilaian per Kriteria</h3>
        `;

        results.forEach(item => {
            detailsArea.innerHTML += `
                <div class="p-4 border rounded-lg shadow-sm bg-white">
                    <h4 class="font-semibold text-lg text-gray-700">${item.kriteria} (${item.bobot}%)</h4>
                    <p class="text-2xl font-bold text-green-600 my-1">Skor: ${item.skor}/100</p>
                    <p class="text-sm text-gray-600 mt-2">Ulasan Penilai:</p>
                    <p class="text-gray-800">${item.feedback}</p>
                </div>
            `;
        });
        
        quizState.status = 'finished';
    }

    function retakeQuiz() {
        // Reset state
        quizState.status = 'initial';
        quizState.studentName = '';
        quizState.studentClass = ''; // Reset kelas
        quizState.startTime = null;
        quizState.elapsedTime = 0;

        // Reset UI
        document.getElementById('result-area').classList.add('hidden');
        document.getElementById('initial-load-area').classList.remove('hidden');
        document.getElementById('student-name-input').value = '';
        document.getElementById('student-class-input').value = ''; // Reset input kelas
        document.getElementById('student-name-input').focus();
        document.getElementById('question-display').textContent = 'Memuat soal...';

        // Reload data
        loadQuizData();
    }
    
    async function saveResultsToSheet(results, averageScore, answer) {
        const timestamp = new Date().toISOString();
        const details = JSON.stringify({
            question: quizState.question.text,
            answer: answer,
            assessment: results
        });

        const dataToSend = {
            timestamp: timestamp,
            studentName: quizState.studentName,
            studentClass: quizState.studentClass, // Kirim data kelas
            subject: currentSettings.examSubject || 'N/A', 
            averageScore: averageScore,
            details: details
        };

        try {
            const url = currentSettings.appsScriptUrl;
            if (!url) {
                showMessage('URL Apps Script tidak ditemukan. Hasil tidak tersimpan online.', 'error');
                return;
            }

            // Using fetch with 'no-cors' mode is necessary for Apps Script POST requests
            // We cannot read the response, only confirm success if no network error
            await fetch(url, {
                method: 'POST',
                mode: 'no-cors', 
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(dataToSend)
            });

            // Since we can't read the response in 'no-cors', assume success if no exception
            showMessage('Hasil ujian berhasil dikirim ke Google Sheet!', 'success');

        } catch (error) {
            console.error('Error saving to Google Sheet:', error);
            showMessage('Gagal mengirim hasil ke Google Sheet. Cek URL Apps Script Anda.', 'error');
        }
    }

    // --- PDF Generation ---

    function downloadResultsAsPDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF('p', 'mm', 'a4');
        const margin = 20;
        let y = margin;
        const pageHeight = doc.internal.pageSize.height;
        
        doc.setFontSize(14);
        doc.setFont('helvetica', 'bold');
        doc.text("LAPORAN HASIL PENILAIAN UJIAN", 105, y, null, null, "center");
        y += 7;

        doc.setFontSize(10);
        doc.setFont('helvetica', 'normal');
        doc.text(`Mata Pelajaran: ${currentSettings.examSubject || 'N/A'}`, margin, y);
        y += 5;
        doc.text(`Materi Ujian: ${currentSettings.examMaterial || 'N/A'}`, margin, y);
        y += 5;
        doc.text(`Nama Siswa: ${quizState.studentName}`, margin, y);
        y += 5;
        doc.text(`Kelas: ${quizState.studentClass}`, margin, y); // Tambahkan Kelas di PDF
        y += 5;
        doc.text(`Skor Rata-rata: ${document.getElementById('result-average-score').textContent}`, margin, y);
        y += 10;
        
        doc.line(margin, y, 210 - margin, y);
        y += 5;

        // Soal Ujian
        doc.setFontSize(12);
        doc.setFont('helvetica', 'bold');
        doc.text("Soal Ujian:", margin, y);
        y += 6;
        doc.setFontSize(10);
        doc.setFont('helvetica', 'normal');
        
        // Split text for question
        const questionText = document.getElementById('question-display').textContent;
        const questionLines = doc.splitTextToSize(questionText, 210 - 2 * margin);
        questionLines.forEach(line => {
            if (y > pageHeight - margin) {
                doc.addPage();
                y = margin;
            }
            doc.text(line, margin, y);
            y += 5;
        });
        y += 5;
        
        // Jawaban Siswa
        doc.setFontSize(12);
        doc.setFont('helvetica', 'bold');
        doc.text("Jawaban Siswa:", margin, y);
        y += 6;
        doc.setFontSize(10);
        doc.setFont('helvetica', 'normal');
        
        // Split text for answer
        const answerText = document.querySelector('#result-details > div:first-child .prose-custom').textContent;
        const answerLines = doc.splitTextToSize(answerText, 210 - 2 * margin);
        answerLines.forEach(line => {
            if (y > pageHeight - margin) {
                doc.addPage();
                y = margin;
            }
            doc.text(line, margin, y);
            y += 5;
        });
        y += 5;

        // Detail Penilaian
        doc.setFontSize(12);
        doc.setFont('helvetica', 'bold');
        doc.text("Detail Penilaian per Kriteria:", margin, y);
        y += 7;

        // Loop through result details
        const resultItems = document.querySelectorAll('#result-details > div:not(:first-child):not(h3)');
        resultItems.forEach(item => {
            if (y > pageHeight - margin - 30) { // Check space for a block
                doc.addPage();
                y = margin;
            }
            
            const title = item.querySelector('h4').textContent;
            const score = item.querySelector('.text-2xl').textContent;
            const feedback = item.querySelector('.text-gray-800').textContent;

            doc.setFontSize(11);
            doc.setFont('helvetica', 'bold');
            doc.text(title, margin, y);
            y += 5;
            
            doc.setFontSize(10);
            doc.setFont('helvetica', 'bold');
            doc.text(score, margin, y);
            y += 5;

            doc.setFont('helvetica', 'normal');
            doc.text("Ulasan Penilai:", margin, y);
            y += 5;

            // Split text for feedback
            const feedbackLines = doc.splitTextToSize(feedback, 210 - 2 * margin);
            feedbackLines.forEach(line => {
                if (y > pageHeight - margin) {
                    doc.addPage();
                    y = margin;
                }
                doc.text(line, margin, y);
                y += 5;
            });
            y += 5;
        });

        // Tanda Tangan Guru
        if (currentSettings.teacherName) {
            if (y > pageHeight - margin - 30) {
                doc.addPage();
                y = margin;
            }
            doc.text("Guru Mata Pelajaran,", 210 - margin - 50, y, null, null, "center");
            y += 20;
            doc.setFont('helvetica', 'bold');
            doc.text(currentSettings.teacherName, 210 - margin - 50, y, null, null, "center");
        }

        doc.save(`Hasil_Ujian_${quizState.studentName}_${quizState.studentClass}.pdf`);
    }

    // --- Generator Functions (Placeholders) ---
    function generateQuestions() {
        showMessage('Fungsi Generate Soal belum diimplementasikan.', 'info');
    }
    
    function createLink() {
        showMessage('Fungsi Generator Link belum diimplementasikan.', 'info');
        const linkOutput = document.getElementById('exam-link-output');
        const tempLink = "https://example.com/ujian-esai-unik-12345";
        linkOutput.value = tempLink;
        document.getElementById('copy-link-btn').disabled = false;
    }

    function copyLink() {
        const linkOutput = document.getElementById('exam-link-output');
        linkOutput.select();
        linkOutput.setSelectionRange(0, 99999); // For mobile devices
        
        try {
            // Use fallback method for clipboard copy in iFrame
            document.execCommand('copy');
            showMessage('Link berhasil disalin!', 'success');
        } catch (err) {
            showMessage('Gagal menyalin link. Silakan salin manual.', 'error');
        }
    }


    // --- Event Listeners and Initialization ---
    document.addEventListener('DOMContentLoaded', () => {
        const studentNameInput = document.getElementById('student-name-input');
        const studentClassInput = document.getElementById('student-class-input'); // Ambil input kelas baru
        const startQuizBtn = document.getElementById('start-quiz-btn');
        const submitAnswerBtn = document.getElementById('submit-answer-btn');
        const retakeQuizBtn = document.getElementById('retake-quiz-btn');
        const downloadPdfBtn = document.getElementById('download-pdf-btn');

        // Settings Buttons
        const teacherSettingsBtn = document.getElementById('teacher-settings-btn');
        const settingsBackdrop = document.getElementById('settings-backdrop');
        const closeSettingsBtn = document.getElementById('close-settings-btn');
        const closeSettingsBtnTop = document.getElementById('close-settings-btn-top');
        const submitPinBtn = document.getElementById('submit-pin-btn');
        const saveSettingsBtn = document.getElementById('save-settings-btn'); // Updated ID from user input

        // Tab Navigation
        const tabConfigBtn = document.getElementById('tab-config-btn');
        const tabGeneratorBtn = document.getElementById('tab-generator-btn');
        const tabLinkGenBtn = document.getElementById('tab-link-gen-btn');
        
        // Generator Buttons
        const generateQuestionsBtn = document.getElementById('generate-questions-btn');
        const createLinkBtn = document.getElementById('create-link-btn');
        const copyLinkBtn = document.getElementById('copy-link-btn');

        // Toolbar
        const writingToolbar = document.getElementById('writing-toolbar');

        // Listener untuk validasi input Nama dan Kelas
        function checkInputs() {
            const isNameFilled = studentNameInput.value.trim() !== '';
            const isClassFilled = studentClassInput.value.trim() !== '';
            const isSettingsReady = currentSettings.sheetUrl && currentSettings.appsScriptUrl && quizState.question;
            startQuizBtn.disabled = !(isNameFilled && isClassFilled && isSettingsReady);
        }

        // Listeners for Quiz Flow
        studentNameInput.addEventListener('input', checkInputs);
        studentClassInput.addEventListener('input', checkInputs); // Tambahkan listener untuk input kelas
        
        startQuizBtn.addEventListener('click', startQuiz);
        submitAnswerBtn.addEventListener('click', () => submitAnswer(false));
        retakeQuizBtn.addEventListener('click', retakeQuiz);
        downloadPdfBtn.addEventListener('click', downloadResultsAsPDF);
        
        // Listeners for Settings Modal
        teacherSettingsBtn.addEventListener('click', openSettingsModal);
        settingsBackdrop.addEventListener('click', closeSettingsModal);
        closeSettingsBtn.addEventListener('click', closeSettingsModal);
        closeSettingsBtnTop.addEventListener('click', closeSettingsModal);
        submitPinBtn.addEventListener('click', checkPin);
        saveSettingsBtn.addEventListener('click', saveSettings); // Hooked up the save function

        // Listeners for Tab Navigation
        tabConfigBtn.addEventListener('click', () => switchTab('config'));
        tabGeneratorBtn.addEventListener('click', () => switchTab('generator'));
        tabLinkGenBtn.addEventListener('click', () => switchTab('link-gen'));
        
        // Listeners for Generator (Placeholders)
        generateQuestionsBtn.addEventListener('click', generateQuestions);
        createLinkBtn.addEventListener('click', createLink);
        copyLinkBtn.addEventListener('click', copyLink);

        // Listeners for Toolbar
        writingToolbar.addEventListener('click', (e) => {
            if (e.target.tagName === 'BUTTON' && e.target.dataset.char) {
                const textarea = document.getElementById('student-answer-input');
                insertAtCursor(textarea, e.target.dataset.char);
            }
        });

        // Initialization
        loadSettings();
        loadQuizData(); // Attempt to load question data based on settings
    });
</script>
</body>
</html>
